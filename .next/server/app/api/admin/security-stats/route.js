"use strict";(()=>{var e={};e.id=5513,e.ids=[5513],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},55314:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>A,patchFetch:()=>g,requestAsyncStorage:()=>S,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f});var s={};r.r(s),r.d(s,{GET:()=>d,dynamic:()=>p});var n=r(49303),i=r(88716),a=r(60670),o=r(62065),u=r(43258),l=r(2095);async function c(e){try{let t=await (0,u.mk)(e);if(t.error)return t.error;if(!(0,u.Fs)(t.user,"admin:read_analytics"))return(0,l.jl)("Admin access required",403);let r={...(0,u.wf)(),rateLimitingEnabled:!0,corsEnabled:!0,securityHeadersEnabled:!0,threatDetectionEnabled:!0,anomalyDetectionEnabled:!0,fraudDetectionEnabled:!0,securityLoggingEnabled:!0,webhookSecurityEnabled:!0,lastUpdated:new Date().toISOString()};return(0,l.x_)(r,"Security statistics retrieved")}catch(e){return console.error("Security stats error:",e),(0,l.jl)("Failed to retrieve security statistics",500)}}let d=(0,o.dU)(c),p="force-dynamic",m=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/security-stats/route",pathname:"/api/admin/security-stats",filename:"route",bundlePath:"app/api/admin/security-stats/route"},resolvedPagePath:"/Users/davicho/MASTER proyectos/FacePay/src/app/api/admin/security-stats/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:S,staticGenerationAsyncStorage:f,serverHooks:h}=m,A="/api/admin/security-stats/route";function g(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},2095:(e,t,r)=>{r.d(t,{jl:()=>o,mk:()=>a,x_:()=>u});var s=r(87070),n=r(75183),i=r(13538);async function a(e){let t=e.headers.get("authorization"),r=(0,n.oA)(t);if(!r)return{user:null,error:s.NextResponse.json({success:!1,error:"Authorization token required"},{status:401})};let a=(0,n.ez)(r);return a?await i._.user.findUnique({where:{id:a.userId}})?{user:a,error:null}:{user:null,error:s.NextResponse.json({success:!1,error:"User not found"},{status:401})}:{user:null,error:s.NextResponse.json({success:!1,error:"Invalid or expired token"},{status:401})}}function o(e,t=400){return s.NextResponse.json({success:!1,error:e},{status:t})}function u(e,t){return s.NextResponse.json({success:!0,data:e,message:t})}},75183:(e,t,r)=>{r.d(t,{X8:()=>o,ez:()=>u,oA:()=>c,si:()=>l});var s=r(41482),n=r.n(s);let i=process.env.JWT_SECRET||"your-secret-key",a=process.env.JWT_REFRESH_SECRET||"your-refresh-secret-key";function o(e){let t={userId:e.id,email:e.email};return{accessToken:n().sign(t,i,{expiresIn:"15m"}),refreshToken:n().sign(t,a,{expiresIn:"7d"}),expiresIn:900}}function u(e){try{return n().verify(e,i)}catch(e){return null}}function l(e){try{return n().verify(e,a)}catch(e){return null}}function c(e){return e&&e.startsWith("Bearer ")?e.substring(7):null}},13538:(e,t,r)=>{r.d(t,{_:()=>i});var s=r(53524);let n=globalThis,i=n.prisma??=new s.PrismaClient({log:["query"]})},43258:(e,t,r)=>{r.d(t,{AH:()=>d,Aj:()=>l,Fs:()=>m,aG:()=>c,mk:()=>p,wf:()=>S});var s=r(87070),n=r(75183),i=r(13538);let a={TOKEN_REFRESH_THRESHOLD:9e5,MAX_LOGIN_ATTEMPTS:5,LOCKOUT_DURATION:18e5,SESSION_TIMEOUT:864e5,CONCURRENT_SESSIONS_LIMIT:5,REQUIRE_FRESH_TOKEN_FOR:["/api/users/profile","/api/payments/stripe/payment-intent","/api/payments/stripe/refund","/api/webauthn/register","/api/transactions/bulk"]},o=new Map,u=new Map;function l(e){let t=Date.now(),r=u.get(e);if(!r){u.set(e,{attempts:1,lockedUntil:0,lastAttempt:t});return}r.attempts++,r.lastAttempt=t,r.attempts>=a.MAX_LOGIN_ATTEMPTS&&(r.lockedUntil=t+a.LOCKOUT_DURATION,console.warn("[Auth Security] IP locked out due to failed attempts:",{ipAddress:e,attempts:r.attempts,lockedUntil:new Date(r.lockedUntil).toISOString(),timestamp:new Date().toISOString()})),u.set(e,r)}function c(e){u.delete(e)}function d(e,t,r,s){o.set(e,{userId:t,lastActivity:Date.now(),ipAddress:r,userAgent:s,refreshCount:0}),function(e){let t=Array.from(o.entries()).filter(([t,r])=>r.userId===e).sort((e,t)=>t[1].lastActivity-e[1].lastActivity);if(t.length>a.CONCURRENT_SESSIONS_LIMIT){let r=t.slice(a.CONCURRENT_SESSIONS_LIMIT);r.forEach(([e])=>{o.delete(e)}),console.log(`[Auth] Cleaned up ${r.length} old sessions for user ${e}`)}}(t)}async function p(e){try{let t=function(e){let t=e.headers.get("x-forwarded-for"),r=e.headers.get("x-real-ip"),s=e.headers.get("x-connecting-ip");return{ipAddress:t?t.split(",")[0].trim():r||s||"unknown",userAgent:e.headers.get("user-agent")||"unknown"}}(e);if(function(e){let t=u.get(e);if(!t)return!1;let r=Date.now();return t.lockedUntil>r||(t.lockedUntil<=r&&t.attempts>=a.MAX_LOGIN_ATTEMPTS&&u.delete(e),!1)}(t.ipAddress)){let r=u.get(t.ipAddress),n=r?new Date(r.lockedUntil).toISOString():"unknown";return console.warn("[Auth] Request from locked out IP:",{ipAddress:t.ipAddress,path:e.nextUrl.pathname,unlockTime:n,timestamp:new Date().toISOString()}),{user:null,error:s.NextResponse.json({success:!1,error:"Too many failed login attempts. Please try again later."},{status:429})}}let r=e.headers.get("authorization"),l=(0,n.oA)(r);if(!l)return{user:null,error:s.NextResponse.json({success:!1,error:"Authorization token required"},{status:401})};let c=(0,n.ez)(l);if(!c)return console.warn("[Auth] Invalid token attempt:",{ipAddress:t.ipAddress,userAgent:t.userAgent.substring(0,100),path:e.nextUrl.pathname,timestamp:new Date().toISOString()}),{user:null,error:s.NextResponse.json({success:!1,error:"Invalid or expired token"},{status:401})};let d=c.sessionId;if(d){if(!function(e,t){let r=o.get(e);return!!r&&(!(Date.now()-r.lastActivity>a.SESSION_TIMEOUT)||(o.delete(e),!1))}(d,t.ipAddress))return console.warn("[Auth] Invalid session:",{sessionId:d,userId:c.userId,ipAddress:t.ipAddress,path:e.nextUrl.pathname,timestamp:new Date().toISOString()}),{user:null,error:s.NextResponse.json({success:!1,error:"Session expired or invalid"},{status:401})};!function(e){let t=o.get(e);t&&(t.lastActivity=Date.now(),o.set(e,t))}(d)}let p=await i._.user.findUnique({where:{id:c.userId},select:{id:!0,email:!0,isActive:!0,lastLoginAt:!0}});if(!p||!p.isActive)return console.warn("[Auth] User not found or inactive:",{userId:c.userId,userExists:!!p,isActive:p?.isActive,ipAddress:t.ipAddress,timestamp:new Date().toISOString()}),{user:null,error:s.NextResponse.json({success:!1,error:"User not found or account deactivated"},{status:401})};let m=Date.now(),S=(c.exp?1e3*c.exp:m+9e5)-m<a.TOKEN_REFRESH_THRESHOLD;if(a.REQUIRE_FRESH_TOKEN_FOR.some(t=>e.nextUrl.pathname.startsWith(t))&&S)return{user:null,error:s.NextResponse.json({success:!1,error:"Fresh authentication required for this operation"},{status:401})};return console.log("[Auth] Successful authentication:",{userId:c.userId,email:p.email,sessionId:c.sessionId,ipAddress:t.ipAddress,path:e.nextUrl.pathname,needsRefresh:S,timestamp:new Date().toISOString()}),{user:{...c,sessionId:c.sessionId||"legacy",needsRefresh:S},error:null}}catch(t){return console.error("[Auth] Authentication middleware error:",{error:t instanceof Error?t.message:String(t),stack:t instanceof Error?t.stack:void 0,path:e.nextUrl.pathname,timestamp:new Date().toISOString()}),{user:null,error:s.NextResponse.json({success:!1,error:"Authentication processing error"},{status:500})}}}function m(e,t,r){switch(t){case"read:own_profile":case"update:own_profile":case"delete:own_account":case"create:payment":case"read:own_transactions":return!0;case"create:refund":return r?.userId===e.userId&&r?.createdAt&&Date.now()-new Date(r.createdAt).getTime()<2592e6;case"admin:read_all_users":case"admin:read_analytics":return"admin"===e.role||"super_admin"===e.role;default:return!1}}function S(){let e=Date.now();return{activeSessions:Array.from(o.values()).filter(t=>e-t.lastActivity<=a.SESSION_TIMEOUT).length,lockedIPs:Array.from(u.values()).filter(t=>t.lockedUntil>e).length,totalLoginAttempts:Array.from(u.values()).reduce((e,t)=>e+t.attempts,0)}}"undefined"!=typeof setInterval&&setInterval(function(){let e=Date.now(),t=0,r=0;for(let[r,s]of o.entries())e-s.lastActivity>a.SESSION_TIMEOUT&&(o.delete(r),t++);for(let[t,s]of u.entries())s.lockedUntil>0&&s.lockedUntil<=e&&(u.delete(t),r++);(t>0||r>0)&&console.log(`[Auth] Cleaned up ${t} expired sessions and ${r} expired lockouts`)},6e5)},62065:(e,t,r)=>{r.d(t,{Qx:()=>d,U:()=>c,bY:()=>m,dU:()=>p});var s=r(87070);let n=new Map,i={DEFAULT_WINDOW:9e5,DEFAULT_MAX_REQUESTS:100,STRICT_MAX_REQUESTS:50,AUTH_MAX_REQUESTS:10,PAYMENT_MAX_REQUESTS:20,ALLOWED_ORIGINS:["https://facepay.app","https://www.facepay.app","http://localhost:3000","https://facepay-mx.vercel.app"].filter(Boolean),CSP:"default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://api.stripe.com wss:; frame-src https://js.stripe.com https://hooks.stripe.com",HSTS:"max-age=31536000; includeSubDomains; preload"};function a(e){let t=e.headers.get("x-forwarded-for"),r=e.headers.get("x-real-ip"),s=e.headers.get("x-connecting-ip");return t?t.split(",")[0].trim():r||s||"unknown"}function o(e,t){let r=e.headers.get("origin");return(!r||i.ALLOWED_ORIGINS.includes("*")||i.ALLOWED_ORIGINS.includes(r))&&t.headers.set("Access-Control-Allow-Origin",r||"*"),t.headers.set("Access-Control-Allow-Methods","GET, POST, PUT, DELETE, OPTIONS"),t.headers.set("Access-Control-Allow-Headers","Content-Type, Authorization, X-Requested-With"),t.headers.set("Access-Control-Allow-Credentials","true"),t.headers.set("Access-Control-Max-Age","86400"),t}function u(e){return e.headers.set("Content-Security-Policy",i.CSP),e.headers.set("Strict-Transport-Security",i.HSTS),e.headers.set("X-Frame-Options","DENY"),e.headers.set("X-Content-Type-Options","nosniff"),e.headers.set("X-XSS-Protection","1; mode=block"),e.headers.set("Referrer-Policy","strict-origin-when-cross-origin"),e.headers.set("Permissions-Policy","camera=(), microphone=(), geolocation=(), payment=()"),e.headers.delete("Server"),e.headers.delete("X-Powered-By"),e}function l(e,t={}){return async r=>{try{if("OPTIONS"===r.method){let e=new s.NextResponse(null,{status:200});return o(r,u(e))}if(!t.skipValidation){let e=function(e){let t=e.headers.get("user-agent"),r=e.headers.get("content-type"),n=e.headers.get("content-length");if(e.headers.get("referer"),!t)return console.warn("[Security] Request blocked - missing user agent:",{ip:a(e),path:e.nextUrl.pathname,timestamp:new Date().toISOString()}),s.NextResponse.json({success:!1,error:"Invalid request"},{status:400});if([/sqlmap/i,/nikto/i,/w3af/i,/nmap/i,/masscan/i,/zmap/i,/nessus/i,/openvas/i,/bot.*crawler/i,/scanner/i].some(e=>e.test(t)))return console.warn("[Security] Suspicious user agent blocked:",{ip:a(e),userAgent:t,path:e.nextUrl.pathname,timestamp:new Date().toISOString()}),s.NextResponse.json({success:!1,error:"Request rejected"},{status:403});if(["POST","PUT","PATCH"].includes(e.method)){if(n&&parseInt(n)>52428800)return console.warn("[Security] Request blocked - payload too large:",{ip:a(e),contentLength:n,path:e.nextUrl.pathname,timestamp:new Date().toISOString()}),s.NextResponse.json({success:!1,error:"Payload too large"},{status:413});!r||r.includes("application/json")||r.includes("multipart/form-data")||r.includes("text/plain")||console.warn("[Security] Invalid content type:",{ip:a(e),contentType:r,path:e.nextUrl.pathname,timestamp:new Date().toISOString()})}return null}(r);if(e)return u(e)}if(!t.skipRateLimit){let e=t.rateLimitOptions||{windowMs:i.DEFAULT_WINDOW,maxRequests:i.DEFAULT_MAX_REQUESTS},o=(function(e){let{windowMs:t,maxRequests:r,skipSuccessfulRequests:i=!1}=e;return e=>{let i=a(e),o=e.headers.get("user-agent")||"unknown",u=`${i}:${e.nextUrl.pathname}:${o.substring(0,50)}`,l=Date.now(),c=n.get(u);return!c||c.resetTime<=l?(n.set(u,{count:1,resetTime:l+t}),null):c.count>=r?(console.warn("[Security] Rate limit exceeded:",{ip:i,path:e.nextUrl.pathname,userAgent:o.substring(0,100),count:c.count,maxRequests:r,timestamp:new Date().toISOString()}),s.NextResponse.json({success:!1,error:"Too many requests. Please try again later.",rateLimitExceeded:!0},{status:429,headers:{"Retry-After":Math.ceil((c.resetTime-l)/1e3).toString(),"X-RateLimit-Limit":r.toString(),"X-RateLimit-Remaining":"0","X-RateLimit-Reset":c.resetTime.toString()}})):(c.count++,n.set(u,c),null)}})(e)(r);if(o)return u(o)}let l=await e(r);return o(r,u(l))}catch(e){return console.error("[Security] Middleware error:",{error:e instanceof Error?e.message:String(e),stack:e instanceof Error?e.stack:void 0,path:r.nextUrl.pathname,method:r.method,ip:a(r),timestamp:new Date().toISOString()}),u(s.NextResponse.json({success:!1,error:"Internal security error"},{status:500}))}}}let c=e=>l(e,{rateLimitOptions:{windowMs:i.DEFAULT_WINDOW,maxRequests:i.AUTH_MAX_REQUESTS}}),d=e=>l(e,{rateLimitOptions:{windowMs:i.DEFAULT_WINDOW,maxRequests:i.PAYMENT_MAX_REQUESTS}}),p=e=>l(e,{rateLimitOptions:{windowMs:i.DEFAULT_WINDOW,maxRequests:i.STRICT_MAX_REQUESTS}}),m=e=>l(e,{skipRateLimit:!0,skipValidation:!0});"undefined"!=typeof setInterval&&setInterval(function(){let e=Date.now(),t=0;for(let[r,s]of n.entries())s.resetTime<=e&&(n.delete(r),t++);t>0&&console.log(`[Security] Cleaned up ${t} expired rate limit entries`)},3e5)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972,1482],()=>r(55314));module.exports=s})();