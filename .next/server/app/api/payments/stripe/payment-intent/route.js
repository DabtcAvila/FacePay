"use strict";(()=>{var e={};e.id=7467,e.ids=[7467],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},90967:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>E,requestAsyncStorage:()=>N,routeModule:()=>M,serverHooks:()=>U,staticGenerationAsyncStorage:()=>R});var a={};r.r(a),r.d(a,{POST:()=>w,PUT:()=>S,dynamic:()=>I});var n=r(49303),s=r(88716),i=r(60670),o=r(13538),u=r(2095),d=r(62065),c=r(1741),p=r(43258),m=r(89557),l=r(60526),_=r(98682),y=r(48472);let I="force-dynamic",h=new y.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-06-20"}),T={MAX_AMOUNT_PER_TRANSACTION:1e4,MAX_AMOUNT_PER_HOUR:5e4,MAX_TRANSACTIONS_PER_HOUR:20,SUSPICIOUS_AMOUNT_PATTERNS:[100,200,500,1e3,1500,2e3]};async function A(e){let t,r;let a=Date.now(),n=null;try{if(t=e.headers.get("user-agent")||void 0,r=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,(n=await (0,p.mk)(e)).error)return n.error;l.co.trackFunnelStep(l.T7.PAYMENT,"payment_initiated",1,{user_id:n.user.userId,user_agent:t,ip_address:r,timestamp:new Date().toISOString()}),l.co.track(l.FP.PAYMENT_INITIATED,{user_id:n.user.userId,initiated_at:new Date().toISOString()});let s=(0,m.k_)(e);if(s.shouldBlock)return l.co.track("Payment Blocked",{reason:"threat_analysis",user_id:n.user.userId,threats:s.threats,funnel:l.T7.PAYMENT,step:"security_check"}),(0,m.H4)(e,{reason:"Threat analysis blocked request",threats:s.threats},n.user.userId),(0,u.jl)("Request blocked due to security concerns",403);let i=await (0,c.ZW)(e);if(i.error)return l.co.track("Payment Failed",{reason:"validation_error",user_id:n.user.userId,funnel:l.T7.PAYMENT,step:"validation"}),i.error;let{amount:d,currency:y,paymentMethodId:I,description:T,metadata:A}=i.data;l.co.trackFunnelStep(l.T7.PAYMENT,"validation_passed",2,{user_id:n.user.userId,amount:d,currency:y||"USD",has_payment_method:!!I,payment_method_id:I});let f=await P(n.user.userId,d,e);if(!f.allowed)return l.co.track("Payment Blocked",{reason:"fraud_detection",user_id:n.user.userId,fraud_reason:f.reason,amount:d,currency:y||"USD",details:f.details,funnel:l.T7.PAYMENT,step:"fraud_check"}),(0,m.H4)(e,{reason:f.reason,amount:d,currency:y,details:f.details},n.user.userId),(0,u.jl)(`Payment blocked: ${f.reason}`,403);l.co.trackFunnelStep(l.T7.PAYMENT,"security_checks_passed",3,{user_id:n.user.userId,amount:d,currency:y||"USD"});let w={amount:Math.round(100*d),currency:(y||"usd").toLowerCase(),customer:n.user.userId,metadata:{userId:n.user.userId,...A},...T&&{description:T}};I&&(w.payment_method=I,w.confirmation_method="manual",w.confirm=!0,w.return_url="http://localhost:3000/payments/success");let S=await h.paymentIntents.create(w),M=null;I&&(M=await o._.paymentMethod.findFirst({where:{userId:n.user.userId,details:{path:["stripePaymentMethodId"],equals:I}}}));let N=await o._.transaction.create({data:{userId:n.user.userId,amount:d,currency:(y||"USD").toUpperCase(),status:"pending",paymentMethodId:M?.id||"stripe-temp",description:T||"Stripe payment",metadata:{stripePaymentIntentId:S.id,...A}}});return l.co.trackFunnelStep(l.T7.PAYMENT,"payment_intent_created",4,{user_id:n.user.userId,payment_intent_id:S.id,transaction_id:N.id,amount:d,currency:y||"USD",status:S.status,creation_time_ms:Date.now()-a}),M&&l.co.trackFeatureUsage("payment_methods","used_saved_method",{user_id:n.user.userId,payment_method_id:M.id,payment_method_type:M.type}),_.Rc.addBreadcrumb(`Payment intent created: ${S.id}`,"payment","info",{userId:n.user.userId,paymentIntentId:S.id,transactionId:N.id,amount:d,currency:y||"USD"}),_.Rc.trackPerformanceMetric("payment_intent_creation",Date.now()-a,{success:!0,amount:d,has_payment_method:!!I}),(0,u.x_)({clientSecret:S.client_secret,paymentIntentId:S.id,transactionId:N.id,status:S.status})}catch(i){let s=Date.now()-a;return l.co.track("Payment Failed",{reason:"system_error",user_id:n?.user?.userId,error_message:i.message,funnel:l.T7.PAYMENT,step:"payment_intent_creation"}),_.Rc.captureException(i,{extra:{context:"payment_intent_creation",user_id:n?.user?.userId,user_agent:t,ip_address:r,duration:s},tags:{endpoint:"/api/payments/stripe/payment-intent",operation:"create_payment_intent"}}),console.error("Payment intent error:",i),(0,m.Lu)(e,"Payment intent creation failed",n?.user?.userId,m.V6.MEDIUM),(0,u.jl)("Failed to create payment intent",500)}}async function P(e,t,r){let a=new Date(new Date().getTime()-36e5);try{if(t>T.MAX_AMOUNT_PER_TRANSACTION)return{allowed:!1,reason:"Transaction amount exceeds maximum allowed limit",details:{amount:t,limit:T.MAX_AMOUNT_PER_TRANSACTION}};if(T.SUSPICIOUS_AMOUNT_PATTERNS.includes(t)){let r=await o._.transaction.count({where:{userId:e,amount:t,createdAt:{gte:a}}});if(r>0)return{allowed:!1,reason:"Suspicious repeated amount pattern detected",details:{amount:t,recentCount:r}}}let r=await o._.transaction.count({where:{userId:e,createdAt:{gte:a}}});if(r>=T.MAX_TRANSACTIONS_PER_HOUR)return{allowed:!1,reason:"Too many transactions in the last hour",details:{count:r,limit:T.MAX_TRANSACTIONS_PER_HOUR}};let n=await o._.transaction.aggregate({where:{userId:e,createdAt:{gte:a},status:{in:["completed","pending"]}},_sum:{amount:!0}}),s=(Number(n._sum.amount)||0)+t;if(s>T.MAX_AMOUNT_PER_HOUR)return{allowed:!1,reason:"Total transaction amount in last hour exceeds limit",details:{currentTotal:n._sum.amount||0,newAmount:t,projectedTotal:s,limit:T.MAX_AMOUNT_PER_HOUR}};return{allowed:!0}}catch(t){return console.error("Fraud check error:",t),(0,m.Lu)(r,"Fraud check system error",e,m.V6.HIGH),{allowed:!0}}}async function f(e){let t=null;try{if((t=await (0,p.mk)(e)).error)return t.error;let{paymentIntentId:r}=await e.json();if(!r)return(0,u.jl)("Payment intent ID is required",400);let a=await o._.transaction.findFirst({where:{userId:t.user.userId,metadata:{path:["stripePaymentIntentId"],equals:r}}});if(!a)return(0,m.Lu)(e,"Attempted to confirm unowned payment intent",t.user.userId,m.V6.HIGH),(0,u.jl)("Payment intent not found or access denied",403);let n=await h.paymentIntents.confirm(r);return await o._.transaction.update({where:{id:a.id},data:{status:"succeeded"===n.status?"completed":"failed",completedAt:"succeeded"===n.status?new Date:null}}),(0,u.x_)({paymentIntentId:n.id,status:n.status})}catch(r){return console.error("Confirm payment intent error:",r),(0,m.Lu)(e,"Payment intent confirmation failed",t?.user?.userId,m.V6.MEDIUM),(0,u.jl)("Failed to confirm payment intent",500)}}let w=(0,d.Qx)(A),S=(0,d.Qx)(f),M=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/payments/stripe/payment-intent/route",pathname:"/api/payments/stripe/payment-intent",filename:"route",bundlePath:"app/api/payments/stripe/payment-intent/route"},resolvedPagePath:"/Users/davicho/MASTER proyectos/FacePay/src/app/api/payments/stripe/payment-intent/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:N,staticGenerationAsyncStorage:R,serverHooks:U}=M,x="/api/payments/stripe/payment-intent/route";function E(){return(0,i.patchFetch)({serverHooks:U,staticGenerationAsyncStorage:R})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,1482,1585,8472,7,5120,5252],()=>r(90967));module.exports=a})();