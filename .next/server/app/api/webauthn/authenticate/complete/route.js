"use strict";(()=>{var e={};e.id=694,e.ids=[694],e.modules={53524:e=>{e.exports=require("@prisma/client")},3473:e=>{e.exports=require("@simplewebauthn/server")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},64780:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>A,patchFetch:()=>x,requestAsyncStorage:()=>y,routeModule:()=>g,serverHooks:()=>I,staticGenerationAsyncStorage:()=>b});var i={};r.r(i),r.d(i,{POST:()=>v,dynamic:()=>f});var n=r(49303),a=r(88716),o=r(60670),s=r(13538),c=r(2095),u=r(75183),l=r(60172),d=r(3473),p=r(91585),h=r(26033);let f="force-dynamic",m=p.Ry({credential:p.Ry({id:p.Z_(),rawId:p.Z_(),response:p.Ry({authenticatorData:p.Z_(),clientDataJSON:p.Z_(),signature:p.Z_(),userHandle:p.Z_().optional()}),type:p.i0("public-key"),clientExtensionResults:p.IM(p.Yj()).optional()}),email:p.Z_().email().optional()});async function v(e){try{let t=await e.json(),{credential:r,email:i}=m.parse(t),n=await s._.webauthnCredential.findUnique({where:{credentialId:r.id},include:{user:{select:{id:!0,email:!0,name:!0,currentChallenge:!0,createdAt:!0,updatedAt:!0}}}});if(!n)return(0,c.jl)("Credential not found. Please register your biometric data first.",404);if(i&&n.user.email!==i)return(0,c.jl)("Credential does not match the provided email",403);let a=[process.env.WEBAUTHN_ORIGIN||"http://localhost:3000","https://localhost:3000","http://localhost:3000"];console.log("[WebAuthn Authentication Complete] Processing authentication completion:",{userId:n.user.id,email:n.user.email,credentialId:r.id,timestamp:new Date().toISOString(),userAgent:e.headers.get("user-agent"),origin:e.headers.get("origin"),expectedOrigins:a,expectedRPID:process.env.WEBAUTHN_RP_ID||"localhost",hasChallenge:!!n.user.currentChallenge});let o=n.user.currentChallenge;if(!o)try{o=JSON.parse(Buffer.from(r.response.clientDataJSON,"base64url").toString("utf-8")).challenge}catch(e){return(0,c.jl)("Invalid client data format and no stored challenge found",400)}if(!o)return(0,c.jl)("Unable to determine expected challenge for verification",400);let p={credentialID:n.credentialId,credentialPublicKey:Buffer.from(n.publicKey,"base64url"),counter:Number(n.counter)},h=await (0,d.verifyAuthenticationResponse)({response:r,expectedChallenge:o,expectedOrigin:a,expectedRPID:process.env.WEBAUTHN_RP_ID||"localhost",authenticator:p,requireUserVerification:!1});if(!h.verified)return console.error("[WebAuthn Authentication Complete] Verification failed:",{userId:n.user.id,credentialId:r.id,timestamp:new Date().toISOString()}),(0,c.jl)("WebAuthn authentication verification failed",401);h.verified&&console.log("[WebAuthn Authentication Complete] Authentication verification successful:",{userId:n.user.id,credentialId:r.id,newCounter:h.authenticationInfo.newCounter,userVerified:h.authenticationInfo.userVerified});let f={userAgent:e.headers.get("user-agent")||"",platform:"unknown"},v=l.G.validateBiometricAuthentication({credentialDeviceType:n.deviceType,credentialBackedUp:n.backedUp,userVerified:h.authenticationInfo.userVerified},f);if(!v.isValid)return console.error("[WebAuthn Authentication Complete] Biometric validation failed:",{userId:n.user.id,reason:v.reason,credentialDeviceType:n.deviceType,credentialBackedUp:n.backedUp,userVerified:h.authenticationInfo.userVerified}),(0,c.jl)(v.reason||"Biometric authentication validation failed",401);let g=l.G.analyzeBiometricAuthentication({credentialDeviceType:n.deviceType,credentialBackedUp:n.backedUp,userVerified:h.authenticationInfo.userVerified},f);l.G.logBiometricAuthenticationResult(g,n.user.id,{verified:!0,credentialDeviceType:n.deviceType,credentialBackedUp:n.backedUp,userVerified:h.authenticationInfo.userVerified}),await s._.$transaction([s._.webauthnCredential.update({where:{id:n.id},data:{counter:BigInt(h.authenticationInfo.newCounter)}}),s._.user.update({where:{id:n.user.id},data:{currentChallenge:null,updatedAt:new Date}})]),console.log("[WebAuthn Authentication Complete] Biometric authentication completed successfully:",{userId:n.user.id,email:n.user.email,credentialId:r.id,deviceType:n.deviceType,backedUp:n.backedUp,userVerified:h.authenticationInfo.userVerified,authenticatorType:g.authenticatorType,biometricUsed:g.biometricUsed,platform:g.platformInfo,timestamp:new Date().toISOString()});let y=(0,u.X8)(n.user);return(0,c.x_)({success:!0,verified:!0,biometricVerified:h.authenticationInfo.userVerified,authenticatorType:g.authenticatorType,biometricUsed:g.biometricUsed,user:{id:n.user.id,email:n.user.email,name:n.user.name},token:y.accessToken,tokens:{accessToken:y.accessToken,refreshToken:y.refreshToken,expiresIn:y.expiresIn},deviceInfo:g.platformInfo,loginMethod:"webauthn_biometric",message:"Biometric authentication completed successfully - platform authenticator verified"},"WebAuthn biometric authentication completed")}catch(t){if(t instanceof h.jm)return console.error("[WebAuthn Authentication Complete] Invalid request format:",t.errors),(0,c.jl)("Invalid request format: "+t.errors[0].message,400);return console.error("[WebAuthn Authentication Complete] Authentication completion failed:",{error:t instanceof Error?t.message:String(t),stack:t instanceof Error?t.stack:void 0,timestamp:new Date().toISOString(),userAgent:e.headers.get("user-agent")}),(0,c.jl)("Failed to complete biometric authentication",500)}}let g=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/webauthn/authenticate/complete/route",pathname:"/api/webauthn/authenticate/complete",filename:"route",bundlePath:"app/api/webauthn/authenticate/complete/route"},resolvedPagePath:"/Users/davicho/MASTER proyectos/FacePay/src/app/api/webauthn/authenticate/complete/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:y,staticGenerationAsyncStorage:b,serverHooks:I}=g,A="/api/webauthn/authenticate/complete/route";function x(){return(0,o.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:b})}},68570:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"createProxy",{enumerable:!0,get:function(){return i}});let i=r(51749).createClientModuleProxy},51749:(e,t,r)=>{e.exports=r(23191).vendored["react-rsc"].ReactServerDOMWebpackServerEdge},2095:(e,t,r)=>{r.d(t,{jl:()=>s,mk:()=>o,x_:()=>c});var i=r(87070),n=r(75183),a=r(13538);async function o(e){let t=e.headers.get("authorization"),r=(0,n.oA)(t);if(!r)return{user:null,error:i.NextResponse.json({success:!1,error:"Authorization token required"},{status:401})};let o=(0,n.ez)(r);return o?await a._.user.findUnique({where:{id:o.userId}})?{user:o,error:null}:{user:null,error:i.NextResponse.json({success:!1,error:"User not found"},{status:401})}:{user:null,error:i.NextResponse.json({success:!1,error:"Invalid or expired token"},{status:401})}}function s(e,t=400){return i.NextResponse.json({success:!1,error:e},{status:t})}function c(e,t){return i.NextResponse.json({success:!0,data:e,message:t})}},75183:(e,t,r)=>{r.d(t,{X8:()=>s,ez:()=>c,oA:()=>l,si:()=>u});var i=r(41482),n=r.n(i);let a=process.env.JWT_SECRET||"your-secret-key",o=process.env.JWT_REFRESH_SECRET||"your-refresh-secret-key";function s(e){let t={userId:e.id,email:e.email};return{accessToken:n().sign(t,a,{expiresIn:"15m"}),refreshToken:n().sign(t,o,{expiresIn:"7d"}),expiresIn:900}}function c(e){try{return n().verify(e,a)}catch(e){return null}}function u(e){try{return n().verify(e,o)}catch(e){return null}}function l(e){return e&&e.startsWith("Bearer ")?e.substring(7):null}},13538:(e,t,r)=>{r.d(t,{_:()=>a});var i=r(53524);let n=globalThis,a=n.prisma??=new i.PrismaClient({log:["query"]})},60172:(e,t,r)=>{r.d(t,{G:()=>s});var i=r(68570);let n=(0,i.createProxy)(String.raw`/Users/davicho/MASTER proyectos/FacePay/src/services/webauthn.ts`),{__esModule:a,$$typeof:o}=n;n.default;let s=(0,i.createProxy)(String.raw`/Users/davicho/MASTER proyectos/FacePay/src/services/webauthn.ts#WebAuthnService`)}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[8948,5972,1482,1585],()=>r(64780));module.exports=i})();