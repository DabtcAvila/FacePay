"use strict";(()=>{var e={};e.id=7606,e.ids=[7606],e.modules={53524:e=>{e.exports=require("@prisma/client")},3473:e=>{e.exports=require("@simplewebauthn/server")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},15484:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>f,serverHooks:()=>A,staticGenerationAsyncStorage:()=>b});var n={};r.r(n),r.d(n,{POST:()=>m,dynamic:()=>h});var i=r(49303),o=r(88716),a=r(60670),s=r(13538),u=r(2095),c=r(3473),l=r(91585),d=r(26033);let h="force-dynamic",p=l.Ry({email:l.Z_().email("Invalid email address").optional(),userId:l.Z_().optional()});async function m(e){try{let t=await e.json(),{email:r,userId:n}=p.parse(t);console.log("[WebAuthn Authentication] Starting biometric authentication:",{email:r||"not provided",userId:n||"not provided",timestamp:new Date().toISOString(),userAgent:e.headers.get("user-agent"),origin:e.headers.get("origin")});let i=[],o=null;if(r){if(!(o=await s._.user.findUnique({where:{email:r},include:{webauthnCredentials:!0}})))return console.error("[WebAuthn Authentication] User not found by email:",r),(0,u.jl)("User not found",404);if(0===o.webauthnCredentials.length)return console.error("[WebAuthn Authentication] No biometric credentials found for user:",r),(0,u.jl)("No biometric credentials found for this user. Please register your biometric data first.",404);i=o.webauthnCredentials.map(e=>({id:e.credentialId,transports:e.transports||["internal"]})),console.log("[WebAuthn Authentication] Found credentials for user:",{email:r,credentialCount:i.length,deviceTypes:o.webauthnCredentials.map(e=>e.deviceType)})}else if(n){if(!(o=await s._.user.findUnique({where:{id:n},include:{webauthnCredentials:!0}})))return console.error("[WebAuthn Authentication] User not found by ID:",n),(0,u.jl)("User not found",404);if(0===o.webauthnCredentials.length)return console.error("[WebAuthn Authentication] No biometric credentials found for userId:",n),(0,u.jl)("No biometric credentials found for this user. Please register your biometric data first.",404);i=o.webauthnCredentials.map(e=>({id:e.credentialId,transports:e.transports||["internal"]})),console.log("[WebAuthn Authentication] Found credentials for userId:",{userId:n,credentialCount:i.length,deviceTypes:o.webauthnCredentials.map(e=>e.deviceType)})}if(!o)return console.error("[WebAuthn Authentication] No user provided for authentication"),(0,u.jl)("Email or userId is required for biometric authentication",400);let a=await (0,c.generateAuthenticationOptions)({timeout:6e4,allowCredentials:i.length>0?i:void 0,userVerification:"preferred",rpID:process.env.WEBAUTHN_RP_ID||"localhost"});return console.log("[WebAuthn Authentication] Generated authentication options:",{userId:o.id,email:o.email,credentialCount:i?.length||0,userVerification:"preferred",biometricRequired:!0,platformAuthenticatorRequired:!0,challengeLength:a.challenge.length,rpID:process.env.WEBAUTHN_RP_ID||"localhost",origin:e.headers.get("origin"),timestamp:new Date().toISOString()}),o&&await s._.user.update({where:{id:o.id},data:{currentChallenge:a.challenge}}),console.log("[WebAuthn Authentication] Authentication options created successfully:",{userId:o.id,email:o.email,credentialCount:i?.length||0,biometricRequired:!0,platformAuthenticatorRequired:!0,timestamp:new Date().toISOString()}),(0,u.x_)({options:a,userId:o.id,hasCredentials:!!i&&i.length>0,biometricRequired:!0,platformAuthenticatorRequired:!0,message:"Biometric authentication started successfully - user verification required"},"WebAuthn biometric authentication started")}catch(t){if(t instanceof d.jm)return console.error("[WebAuthn Authentication] Invalid request format:",t.errors),(0,u.jl)("Invalid request format: "+t.errors[0].message,400);return console.error("[WebAuthn Authentication] Authentication start failed:",{error:t instanceof Error?t.message:String(t),stack:t instanceof Error?t.stack:void 0,timestamp:new Date().toISOString(),userAgent:e.headers.get("user-agent")}),(0,u.jl)("Failed to start biometric authentication",500)}}let f=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/webauthn/authenticate/start/route",pathname:"/api/webauthn/authenticate/start",filename:"route",bundlePath:"app/api/webauthn/authenticate/start/route"},resolvedPagePath:"/Users/davicho/MASTER proyectos/FacePay/src/app/api/webauthn/authenticate/start/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:g,staticGenerationAsyncStorage:b,serverHooks:A}=f,v="/api/webauthn/authenticate/start/route";function w(){return(0,a.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:b})}},2095:(e,t,r)=>{r.d(t,{jl:()=>s,mk:()=>a,x_:()=>u});var n=r(87070),i=r(75183),o=r(13538);async function a(e){let t=e.headers.get("authorization"),r=(0,i.oA)(t);if(!r)return{user:null,error:n.NextResponse.json({success:!1,error:"Authorization token required"},{status:401})};let a=(0,i.ez)(r);return a?await o._.user.findUnique({where:{id:a.userId}})?{user:a,error:null}:{user:null,error:n.NextResponse.json({success:!1,error:"User not found"},{status:401})}:{user:null,error:n.NextResponse.json({success:!1,error:"Invalid or expired token"},{status:401})}}function s(e,t=400){return n.NextResponse.json({success:!1,error:e},{status:t})}function u(e,t){return n.NextResponse.json({success:!0,data:e,message:t})}},75183:(e,t,r)=>{r.d(t,{X8:()=>s,ez:()=>u,oA:()=>l,si:()=>c});var n=r(41482),i=r.n(n);let o=process.env.JWT_SECRET||"your-secret-key",a=process.env.JWT_REFRESH_SECRET||"your-refresh-secret-key";function s(e){let t={userId:e.id,email:e.email};return{accessToken:i().sign(t,o,{expiresIn:"15m"}),refreshToken:i().sign(t,a,{expiresIn:"7d"}),expiresIn:900}}function u(e){try{return i().verify(e,o)}catch(e){return null}}function c(e){try{return i().verify(e,a)}catch(e){return null}}function l(e){return e&&e.startsWith("Bearer ")?e.substring(7):null}},13538:(e,t,r)=>{r.d(t,{_:()=>o});var n=r(53524);let i=globalThis,o=i.prisma??=new n.PrismaClient({log:["query"]})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[8948,5972,1482,1585],()=>r(15484));module.exports=n})();