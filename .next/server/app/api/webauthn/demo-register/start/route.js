"use strict";(()=>{var e={};e.id=7917,e.ids=[7917],e.modules={53524:e=>{e.exports=require("@prisma/client")},3473:e=>{e.exports=require("@simplewebauthn/server")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},78943:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>A,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>h});var i={};r.r(i),r.d(i,{POST:()=>d,dynamic:()=>l});var n=r(49303),s=r(88716),a=r(60670),o=r(13538),u=r(2095),c=r(3473);let l="force-dynamic";async function d(e){try{let{userId:t,userName:r,userDisplayName:i}=await e.json();if(!t||!r)return(0,u.jl)("userId and userName are required",400);let n=await o._.user.upsert({where:{email:r},update:{name:i||r},create:{id:t,email:r,name:i||r},include:{webauthnCredentials:!0}});console.log("[WebAuthn Demo Registration] Starting REAL biometric registration for demo user:",{userId:n.id,email:n.email,existingCredentials:n.webauthnCredentials.length,timestamp:new Date().toISOString(),userAgent:e.headers.get("user-agent")});let s=n.webauthnCredentials.map(e=>({id:e.credentialId,type:"public-key",transports:["internal","hybrid"]})),a=await (0,c.generateRegistrationOptions)({rpName:process.env.WEBAUTHN_RP_NAME||"FacePay Demo",rpID:process.env.WEBAUTHN_RP_ID||"localhost",userID:Buffer.from(n.id,"utf8"),userName:n.email,userDisplayName:n.name||n.email,timeout:6e4,attestationType:"direct",excludeCredentials:s,authenticatorSelection:{authenticatorAttachment:"platform",residentKey:"required",userVerification:"required"},supportedAlgorithmIDs:[-7,-257]});return console.log("[WebAuthn Demo Registration] Generated REAL biometric options:",{userId:n.id,rpID:a.rp.id,authenticatorAttachment:a.authenticatorSelection?.authenticatorAttachment,userVerification:a.authenticatorSelection?.userVerification,residentKey:a.authenticatorSelection?.residentKey,attestationType:a.attestation,challengeLength:a.challenge.length,timestamp:new Date().toISOString()}),await o._.user.update({where:{id:n.id},data:{currentChallenge:a.challenge}}),console.log("[WebAuthn Demo Registration] REAL biometric registration options created successfully:",{userId:n.id,email:n.email,biometricRequired:!0,platformAuthenticator:!0,realWebAuthn:!0,timestamp:new Date().toISOString()}),(0,u.x_)({options:a,userId:n.id,biometricRequired:!0,platformAuthenticatorRequired:!0,realWebAuthn:!0,message:"REAL biometric registration started successfully - platform authenticator required"},"WebAuthn REAL biometric demo registration started")}catch(t){return console.error("[WebAuthn Demo Registration] Registration start failed:",{error:t instanceof Error?t.message:String(t),stack:t instanceof Error?t.stack:void 0,timestamp:new Date().toISOString(),userAgent:e.headers.get("user-agent")}),(0,u.jl)("Failed to start REAL biometric demo registration",500)}}let p=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/webauthn/demo-register/start/route",pathname:"/api/webauthn/demo-register/start",filename:"route",bundlePath:"app/api/webauthn/demo-register/start/route"},resolvedPagePath:"/Users/davicho/MASTER proyectos/FacePay/src/app/api/webauthn/demo-register/start/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:m,staticGenerationAsyncStorage:h,serverHooks:g}=p,f="/api/webauthn/demo-register/start/route";function A(){return(0,a.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:h})}},2095:(e,t,r)=>{r.d(t,{jl:()=>o,mk:()=>a,x_:()=>u});var i=r(87070),n=r(75183),s=r(13538);async function a(e){let t=e.headers.get("authorization"),r=(0,n.oA)(t);if(!r)return{user:null,error:i.NextResponse.json({success:!1,error:"Authorization token required"},{status:401})};let a=(0,n.ez)(r);return a?await s._.user.findUnique({where:{id:a.userId}})?{user:a,error:null}:{user:null,error:i.NextResponse.json({success:!1,error:"User not found"},{status:401})}:{user:null,error:i.NextResponse.json({success:!1,error:"Invalid or expired token"},{status:401})}}function o(e,t=400){return i.NextResponse.json({success:!1,error:e},{status:t})}function u(e,t){return i.NextResponse.json({success:!0,data:e,message:t})}},75183:(e,t,r)=>{r.d(t,{X8:()=>o,ez:()=>u,oA:()=>l,si:()=>c});var i=r(41482),n=r.n(i);let s=process.env.JWT_SECRET||"your-secret-key",a=process.env.JWT_REFRESH_SECRET||"your-refresh-secret-key";function o(e){let t={userId:e.id,email:e.email};return{accessToken:n().sign(t,s,{expiresIn:"15m"}),refreshToken:n().sign(t,a,{expiresIn:"7d"}),expiresIn:900}}function u(e){try{return n().verify(e,s)}catch(e){return null}}function c(e){try{return n().verify(e,a)}catch(e){return null}}function l(e){return e&&e.startsWith("Bearer ")?e.substring(7):null}},13538:(e,t,r)=>{r.d(t,{_:()=>s});var i=r(53524);let n=globalThis,s=n.prisma??=new i.PrismaClient({log:["query"]})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[8948,5972,1482],()=>r(78943));module.exports=i})();