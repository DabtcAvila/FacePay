"use strict";exports.id=5252,exports.ids=[5252],exports.modules={2095:(e,t,r)=>{r.d(t,{jl:()=>i,mk:()=>o,x_:()=>l});var s=r(87070),n=r(75183),a=r(13538);async function o(e){let t=e.headers.get("authorization"),r=(0,n.oA)(t);if(!r)return{user:null,error:s.NextResponse.json({success:!1,error:"Authorization token required"},{status:401})};let o=(0,n.ez)(r);return o?await a._.user.findUnique({where:{id:o.userId}})?{user:o,error:null}:{user:null,error:s.NextResponse.json({success:!1,error:"User not found"},{status:401})}:{user:null,error:s.NextResponse.json({success:!1,error:"Invalid or expired token"},{status:401})}}function i(e,t=400){return s.NextResponse.json({success:!1,error:e},{status:t})}function l(e,t){return s.NextResponse.json({success:!0,data:e,message:t})}},75183:(e,t,r)=>{r.d(t,{X8:()=>i,ez:()=>l,oA:()=>c,si:()=>u});var s=r(41482),n=r.n(s);let a=process.env.JWT_SECRET||"your-secret-key",o=process.env.JWT_REFRESH_SECRET||"your-refresh-secret-key";function i(e){let t={userId:e.id,email:e.email};return{accessToken:n().sign(t,a,{expiresIn:"15m"}),refreshToken:n().sign(t,o,{expiresIn:"7d"}),expiresIn:900}}function l(e){try{return n().verify(e,a)}catch(e){return null}}function u(e){try{return n().verify(e,o)}catch(e){return null}}function c(e){return e&&e.startsWith("Bearer ")?e.substring(7):null}},43258:(e,t,r)=>{r.d(t,{AH:()=>d,Aj:()=>u,Fs:()=>m,aG:()=>c,mk:()=>p,wf:()=>f});var s=r(87070),n=r(75183),a=r(13538);let o={TOKEN_REFRESH_THRESHOLD:9e5,MAX_LOGIN_ATTEMPTS:5,LOCKOUT_DURATION:18e5,SESSION_TIMEOUT:864e5,CONCURRENT_SESSIONS_LIMIT:5,REQUIRE_FRESH_TOKEN_FOR:["/api/users/profile","/api/payments/stripe/payment-intent","/api/payments/stripe/refund","/api/webauthn/register","/api/transactions/bulk"]},i=new Map,l=new Map;function u(e){let t=Date.now(),r=l.get(e);if(!r){l.set(e,{attempts:1,lockedUntil:0,lastAttempt:t});return}r.attempts++,r.lastAttempt=t,r.attempts>=o.MAX_LOGIN_ATTEMPTS&&(r.lockedUntil=t+o.LOCKOUT_DURATION,console.warn("[Auth Security] IP locked out due to failed attempts:",{ipAddress:e,attempts:r.attempts,lockedUntil:new Date(r.lockedUntil).toISOString(),timestamp:new Date().toISOString()})),l.set(e,r)}function c(e){l.delete(e)}function d(e,t,r,s){i.set(e,{userId:t,lastActivity:Date.now(),ipAddress:r,userAgent:s,refreshCount:0}),function(e){let t=Array.from(i.entries()).filter(([t,r])=>r.userId===e).sort((e,t)=>t[1].lastActivity-e[1].lastActivity);if(t.length>o.CONCURRENT_SESSIONS_LIMIT){let r=t.slice(o.CONCURRENT_SESSIONS_LIMIT);r.forEach(([e])=>{i.delete(e)}),console.log(`[Auth] Cleaned up ${r.length} old sessions for user ${e}`)}}(t)}async function p(e){try{let t=function(e){let t=e.headers.get("x-forwarded-for"),r=e.headers.get("x-real-ip"),s=e.headers.get("x-connecting-ip");return{ipAddress:t?t.split(",")[0].trim():r||s||"unknown",userAgent:e.headers.get("user-agent")||"unknown"}}(e);if(function(e){let t=l.get(e);if(!t)return!1;let r=Date.now();return t.lockedUntil>r||(t.lockedUntil<=r&&t.attempts>=o.MAX_LOGIN_ATTEMPTS&&l.delete(e),!1)}(t.ipAddress)){let r=l.get(t.ipAddress),n=r?new Date(r.lockedUntil).toISOString():"unknown";return console.warn("[Auth] Request from locked out IP:",{ipAddress:t.ipAddress,path:e.nextUrl.pathname,unlockTime:n,timestamp:new Date().toISOString()}),{user:null,error:s.NextResponse.json({success:!1,error:"Too many failed login attempts. Please try again later."},{status:429})}}let r=e.headers.get("authorization"),u=(0,n.oA)(r);if(!u)return{user:null,error:s.NextResponse.json({success:!1,error:"Authorization token required"},{status:401})};let c=(0,n.ez)(u);if(!c)return console.warn("[Auth] Invalid token attempt:",{ipAddress:t.ipAddress,userAgent:t.userAgent.substring(0,100),path:e.nextUrl.pathname,timestamp:new Date().toISOString()}),{user:null,error:s.NextResponse.json({success:!1,error:"Invalid or expired token"},{status:401})};let d=c.sessionId;if(d){if(!function(e,t){let r=i.get(e);return!!r&&(!(Date.now()-r.lastActivity>o.SESSION_TIMEOUT)||(i.delete(e),!1))}(d,t.ipAddress))return console.warn("[Auth] Invalid session:",{sessionId:d,userId:c.userId,ipAddress:t.ipAddress,path:e.nextUrl.pathname,timestamp:new Date().toISOString()}),{user:null,error:s.NextResponse.json({success:!1,error:"Session expired or invalid"},{status:401})};!function(e){let t=i.get(e);t&&(t.lastActivity=Date.now(),i.set(e,t))}(d)}let p=await a._.user.findUnique({where:{id:c.userId},select:{id:!0,email:!0,isActive:!0,lastLoginAt:!0}});if(!p||!p.isActive)return console.warn("[Auth] User not found or inactive:",{userId:c.userId,userExists:!!p,isActive:p?.isActive,ipAddress:t.ipAddress,timestamp:new Date().toISOString()}),{user:null,error:s.NextResponse.json({success:!1,error:"User not found or account deactivated"},{status:401})};let m=Date.now(),f=(c.exp?1e3*c.exp:m+9e5)-m<o.TOKEN_REFRESH_THRESHOLD;if(o.REQUIRE_FRESH_TOKEN_FOR.some(t=>e.nextUrl.pathname.startsWith(t))&&f)return{user:null,error:s.NextResponse.json({success:!1,error:"Fresh authentication required for this operation"},{status:401})};return console.log("[Auth] Successful authentication:",{userId:c.userId,email:p.email,sessionId:c.sessionId,ipAddress:t.ipAddress,path:e.nextUrl.pathname,needsRefresh:f,timestamp:new Date().toISOString()}),{user:{...c,sessionId:c.sessionId||"legacy",needsRefresh:f},error:null}}catch(t){return console.error("[Auth] Authentication middleware error:",{error:t instanceof Error?t.message:String(t),stack:t instanceof Error?t.stack:void 0,path:e.nextUrl.pathname,timestamp:new Date().toISOString()}),{user:null,error:s.NextResponse.json({success:!1,error:"Authentication processing error"},{status:500})}}}function m(e,t,r){switch(t){case"read:own_profile":case"update:own_profile":case"delete:own_account":case"create:payment":case"read:own_transactions":return!0;case"create:refund":return r?.userId===e.userId&&r?.createdAt&&Date.now()-new Date(r.createdAt).getTime()<2592e6;case"admin:read_all_users":case"admin:read_analytics":return"admin"===e.role||"super_admin"===e.role;default:return!1}}function f(){let e=Date.now();return{activeSessions:Array.from(i.values()).filter(t=>e-t.lastActivity<=o.SESSION_TIMEOUT).length,lockedIPs:Array.from(l.values()).filter(t=>t.lockedUntil>e).length,totalLoginAttempts:Array.from(l.values()).reduce((e,t)=>e+t.attempts,0)}}"undefined"!=typeof setInterval&&setInterval(function(){let e=Date.now(),t=0,r=0;for(let[r,s]of i.entries())e-s.lastActivity>o.SESSION_TIMEOUT&&(i.delete(r),t++);for(let[t,s]of l.entries())s.lockedUntil>0&&s.lockedUntil<=e&&(l.delete(t),r++);(t>0||r>0)&&console.log(`[Auth] Cleaned up ${t} expired sessions and ${r} expired lockouts`)},6e5)},1741:(e,t,r)=>{r.d(t,{$F:()=>E,ZW:()=>N,_D:()=>v});var s=r(91585),n=r(87070);let a=s.Z_().email("Invalid email address").min(5,"Email must be at least 5 characters").max(255,"Email must not exceed 255 characters").regex(/^[^\s@]+@[^\s@]+\.[^\s@]+$/,"Invalid email format"),o=s.Z_().min(8,"Password must be at least 8 characters").max(128,"Password must not exceed 128 characters").regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/,"Password must contain at least one lowercase letter, one uppercase letter, and one number"),i=s.Z_().min(2,"Name must be at least 2 characters").max(100,"Name must not exceed 100 characters").regex(/^[a-zA-Z\s\-'\.]+$/,"Name can only contain letters, spaces, hyphens, apostrophes, and periods"),l=s.Z_().regex(/^[a-zA-Z0-9_-]+$/,"Invalid ID format").min(1,"ID is required").max(255,"ID too long");s.Z_().uuid("Invalid UUID format"),s.Rx().int("Must be an integer").positive("Must be positive");let u=s.Rx().positive("Amount must be positive").max(1e6,"Amount too large").multipleOf(.01,"Amount must have at most 2 decimal places"),c=s.Z_().length(3,"Currency must be 3 characters").regex(/^[A-Z]{3}$/,"Currency must be uppercase letters"),d=s.Ry({page:s.oQ.number().int().min(1).default(1),limit:s.oQ.number().int().min(1).max(100).default(20)}),p=s.Ry({email:a,password:s.Z_().min(1,"Password is required")}),m=s.Ry({email:a,password:o,name:i}),f=s.Ry({refreshToken:s.Z_().min(1,"Refresh token is required")}),I=s.Ry({name:i.optional(),email:a.optional()}).refine(e=>e.name||e.email,{message:"At least one field must be provided"}),g=s.Ry({amount:u,currency:c.default("USD"),paymentMethodId:s.Z_().optional(),description:s.Z_().max(500,"Description too long").optional(),metadata:s.IM(s.Z_()).optional()}),h=s.Ry({type:s.Km(["card","bank_account","wallet"]),provider:s.Km(["stripe","paypal","apple_pay","google_pay"]),details:s.IM(s.Yj()),isDefault:s.O7().default(!1)}),y=s.Ry({status:s.Km(["pending","completed","failed","refunded"]).optional(),startDate:s.Z_().datetime().optional(),endDate:s.Z_().datetime().optional(),minAmount:s.oQ.number().positive().optional(),maxAmount:s.oQ.number().positive().optional(),paymentMethodId:l.optional()}).merge(d),A=s.Ry({amount:u.optional(),reason:s.Z_().max(500,"Reason too long").optional()});s.Ry({challenge:s.Z_().min(1,"Challenge is required"),userVerification:s.Km(["required","preferred","discouraged"]).default("preferred")});let _=s.Ry({id:s.Z_().min(1),rawId:s.Z_().min(1),response:s.Ry({authenticatorData:s.Z_().optional(),clientDataJSON:s.Z_().min(1),signature:s.Z_().optional(),attestationObject:s.Z_().optional()}),type:s.i0("public-key"),clientExtensionResults:s.IM(s.Yj()).optional()}),R=s.Ry({credential:_}),S=s.Ry({credential:_}),x=s.Ry({startDate:s.Z_().datetime(),endDate:s.Z_().datetime(),groupBy:s.Km(["day","week","month"]).default("day"),metrics:s.IX(s.Km(["transactions","revenue","users","success_rate"])).default(["transactions","revenue"])}),w=s.Ry({type:s.Km(["face_scan","webauthn_passkey","fingerprint"]),data:s.IM(s.Yj()),confidence:s.Rx().min(0).max(1).optional(),metadata:s.IM(s.Yj()).optional()});function O(e,t="body"){return async(r,s)=>{try{let a;switch(t){case"body":try{a=await r.json()}catch(e){return{data:null,error:n.NextResponse.json({success:!1,error:"Invalid JSON in request body",code:"INVALID_JSON"},{status:400})}}break;case"query":a=Object.fromEntries(r.nextUrl.searchParams.entries());break;case"params":a=s||{}}let o=function e(t){if("string"==typeof t)return t.replace(/[<>]/g,"").replace(/javascript:/gi,"").replace(/on\w+=/gi,"").trim();if(Array.isArray(t))return t.map(e);if(t&&"object"==typeof t){let r={};for(let[s,n]of Object.entries(t))r["string"==typeof s?s.replace(/[<>]/g,"").replace(/[^\w.-]/g,"").substring(0,100):s]=e(n);return r}return t}(a),i=e.safeParse(o);if(!i.success){let e=i.error.errors[0];return console.warn("[Validation] Schema validation failed:",{path:r.nextUrl.pathname,source:t,error:e.message,field:e.path.join("."),timestamp:new Date().toISOString()}),{data:null,error:n.NextResponse.json({success:!1,error:`Validation failed: ${e.message}`,code:"VALIDATION_ERROR",field:e.path.join("."),details:i.error.errors.map(e=>({field:e.path.join("."),message:e.message,code:e.code}))},{status:400})}}return{data:i.data,error:null}}catch(e){return console.error("[Validation] Unexpected validation error:",{error:e instanceof Error?e.message:String(e),path:r.nextUrl.pathname,source:t,timestamp:new Date().toISOString()}),{data:null,error:n.NextResponse.json({success:!1,error:"Validation processing error",code:"VALIDATION_PROCESSING_ERROR"},{status:500})}}}}let v=O(p);O(m),O(f);let E=O(I),N=O(g);O(h),O(y,"query"),O(A),O(R),O(S),O(x,"query"),O(w),O(d,"query")}};