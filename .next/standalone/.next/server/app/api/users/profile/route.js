"use strict";(()=>{var e={};e.id=2807,e.ids=[2807],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},39906:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>E,patchFetch:()=>_,requestAsyncStorage:()=>U,routeModule:()=>v,serverHooks:()=>q,staticGenerationAsyncStorage:()=>j});var s={};t.r(s),t.d(s,{DELETE:()=>A,GET:()=>I,PUT:()=>w,dynamic:()=>x});var o=t(49303),i=t(88716),u=t(60670),n=t(13538),a=t(2095),c=t(62065),d=t(1741),l=t(43258),p=t(89557),f=t(26033);async function m(e){try{let r=await (0,l.mk)(e);if(r.error)return r.error;if(!(0,l.Fs)(r.user,"read:own_profile"))return(0,p.Lu)(e,"Unauthorized profile access attempt",r.user.userId,p.V6.MEDIUM),(0,a.jl)("Insufficient permissions",403);let t=await n._B.user.findUnique({where:{id:r.user.userId},select:{id:!0,email:!0,name:!0,createdAt:!0,updatedAt:!0,biometricData:{where:{isActive:!0},select:{id:!0,type:!0,createdAt:!0,isActive:!0}},paymentMethods:{select:{id:!0,type:!0,provider:!0,isDefault:!0,createdAt:!0}},_count:{select:{transactions:!0}}}});if(!t)return(0,a.jl)("User not found",404);return(0,a.x_)(t)}catch(e){return console.error("Get profile error:",e),(0,a.jl)("Internal server error",500)}}async function h(e){try{let r=await (0,l.mk)(e);if(r.error)return r.error;if(!(0,l.Fs)(r.user,"update:own_profile"))return(0,p.Lu)(e,"Unauthorized profile update attempt",r.user.userId,p.V6.MEDIUM),(0,a.jl)("Insufficient permissions",403);if((0,p.k_)(e).shouldBlock)return(0,p.Lu)(e,"Profile update blocked due to security threats",r.user.userId,p.V6.HIGH),(0,a.jl)("Request blocked due to security concerns",403);let t=await (0,d.$F)(e);if(t.error)return t.error;let{name:s,email:o}=t.data;if(o&&await n._B.user.findFirst({where:{email:o,NOT:{id:r.user.userId}}}))return(0,a.jl)("Email is already taken",409);let i=await n._B.user.update({where:{id:r.user.userId},data:{...s&&{name:s},...o&&{email:o}},select:{id:!0,email:!0,name:!0,createdAt:!0,updatedAt:!0}});return(0,a.x_)(i,"Profile updated successfully")}catch(e){if(e instanceof f.jm)return(0,a.jl)(e.errors[0].message,400);return console.error("Update profile error:",e),(0,a.jl)("Internal server error",500)}}async function y(e){let r=null;try{if((r=await (0,l.mk)(e)).error)return r.error;if(!(0,l.Fs)(r.user,"delete:own_account"))return(0,p.Lu)(e,"Unauthorized account deletion attempt",r.user.userId,p.V6.HIGH),(0,a.jl)("Insufficient permissions",403);if(r.user.needsRefresh)return(0,p.Lu)(e,"Account deletion attempted with stale token",r.user.userId,p.V6.HIGH),(0,a.jl)("Fresh authentication required for account deletion",401);return console.log(`[Security] Account deletion requested by user ${r.user.userId}`),await n._B.user.delete({where:{id:r.user.userId}}),(0,a.x_)(null,"Account deleted successfully")}catch(t){return console.error("Delete account error:",t),(0,p.Lu)(e,"Account deletion failed",r?.user?.userId,p.V6.MEDIUM),(0,a.jl)("Internal server error",500)}}let I=(0,c.dU)(m),w=(0,c.dU)(h),A=(0,c.dU)(y),x="force-dynamic",v=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/users/profile/route",pathname:"/api/users/profile",filename:"route",bundlePath:"app/api/users/profile/route"},resolvedPagePath:"/Users/davicho/MASTER proyectos/FacePay/src/app/api/users/profile/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:U,staticGenerationAsyncStorage:j,serverHooks:q}=v,E="/api/users/profile/route";function _(){return(0,u.patchFetch)({serverHooks:q,staticGenerationAsyncStorage:j})}},13538:(e,r,t)=>{t.d(r,{_B:()=>u});var s=t(53524);let o=globalThis,i=process.env.DATABASE_URL,u=o.prisma??=new s.PrismaClient({log:["error","warn"],datasources:{db:{url:i}},...!1,errorFormat:"minimal"});u.$on("query",e=>{e.duration>1e3&&console.warn(`[SLOW QUERY] ${e.duration}ms: ${e.query}`)}),u.$on("error",e=>{console.error("[PRISMA ERROR]:",e)}),process.on("beforeExit",async()=>{await u.$disconnect()}),process.on("SIGINT",async()=>{await u.$disconnect(),process.exit(0)}),process.on("SIGTERM",async()=>{await u.$disconnect(),process.exit(0)})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[8948,5972,1482,1585,5120,5252],()=>t(39906));module.exports=s})();