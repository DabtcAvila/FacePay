"use strict";(()=>{var e={};e.id=7672,e.ids=[7672],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},67055:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>S,patchFetch:()=>_,requestAsyncStorage:()=>x,routeModule:()=>T,serverHooks:()=>E,staticGenerationAsyncStorage:()=>D});var r={};a.r(r),a.d(r,{DELETE:()=>f,GET:()=>w,POST:()=>g,PUT:()=>v,dynamic:()=>l});var s=a(49303),n=a(88716),o=a(60670),i=a(87070),c=a(13538),h=a(98682);let l="force-dynamic";async function u(){let e=Date.now();try{await c._B.$queryRaw`SELECT 1`;let t=await c._B.user.count(),a=Date.now()-e;return{service:"database",status:a>2e3?"degraded":"healthy",responseTime:a,details:{userCount:t,connectionPool:"active"}}}catch(t){return{service:"database",status:"unhealthy",responseTime:Date.now()-e,error:t.message}}}async function d(){let e=[],t=await p("stripe","https://api.stripe.com/v1",{Authorization:`Bearer ${process.env.STRIPE_SECRET_KEY}`});if(e.push(t),process.env.NEXT_PUBLIC_SENTRY_DSN){let t=await p("sentry","https://sentry.io/api/0/",{});e.push(t)}return e}async function p(e,t,a){let r=Date.now();try{let s=new AbortController,n=setTimeout(()=>s.abort(),1e4),o=await fetch(t,{method:"GET",headers:a,signal:s.signal});clearTimeout(n);let i=Date.now()-r;return{service:e,status:o.ok?"healthy":"degraded",responseTime:i,details:{statusCode:o.status,url:t}}}catch(t){return{service:e,status:"unhealthy",responseTime:Date.now()-r,error:t.message}}}async function m(){let e=Date.now();try{let t={nodeVersion:process.version,platform:process.platform,uptime:process.uptime(),environment:"production"};if(process.memoryUsage){let a=process.memoryUsage();t.memory={heapUsed:Math.round(a.heapUsed/1024/1024),heapTotal:Math.round(a.heapTotal/1024/1024),external:Math.round(a.external/1024/1024),rss:Math.round(a.rss/1024/1024)};let r=a.heapUsed/a.heapTotal*100;return{service:"system",status:r>90?"unhealthy":r>70?"degraded":"healthy",responseTime:Date.now()-e,details:t}}return{service:"system",status:"healthy",responseTime:Date.now()-e,details:t}}catch(t){return{service:"system",status:"unhealthy",responseTime:Date.now()-e,error:t.message}}}async function y(){let e=Date.now();try{let t=new Date(Date.now()-3e5),a=await c._B.transaction.count({where:{status:"failed",createdAt:{gte:t}}}),r=await c._B.auditLog.count({where:{action:"auth_failure",createdAt:{gte:t}}}),s=a+r;return{service:"error_monitoring",status:s>10?"unhealthy":s>5?"degraded":"healthy",responseTime:Date.now()-e,details:{recentFailedTransactions:a,recentAuthFailures:r,totalIssues:s,timeWindow:"5 minutes"}}}catch(t){return{service:"error_monitoring",status:"unhealthy",responseTime:Date.now()-e,error:t.message}}}async function g(e){let t=Date.now();try{if(!function(e){let t=e.headers.get("authorization"),a=process.env.CRON_SECRET||process.env.WEBHOOK_SECRET;return!!t&&!!a&&t.replace("Bearer ","")===a}(e))return console.warn("[Cron] Unauthorized health check attempt:",{ip:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip"),userAgent:e.headers.get("user-agent"),timestamp:new Date().toISOString()}),i.NextResponse.json({error:"Unauthorized"},{status:401});let[a,r,s,...n]=await Promise.all([u(),m(),y(),...await d()]),o=[a,r,s,...n],c=o.filter(e=>"unhealthy"===e.status),l=o.filter(e=>"degraded"===e.status),p=c.length>0?"unhealthy":l.length>0?"degraded":"healthy",g=Date.now()-t,w={status:p,timestamp:new Date().toISOString(),totalCheckTime:g,services:{healthy:o.filter(e=>"healthy"===e.status).length,degraded:l.length,unhealthy:c.length,total:o.length},checks:o};if("healthy"!==p&&console.warn(`[Health Check] System status: ${p}`,{unhealthyServices:c.map(e=>e.service),degradedServices:l.map(e=>e.service),timestamp:new Date().toISOString()}),c.length>0){let e=c.filter(e=>["database","system"].includes(e.service));e.length>0&&h.Rc.captureException(Error("Critical system health issues detected"),{extra:{unhealthyServices:e,healthReport:w},tags:{job:"health_check",severity:"critical"}})}return h.Rc.trackPerformanceMetric("health_check",g,{overall_status:p,services_checked:o.length,services_unhealthy:c.length}),i.NextResponse.json(w)}catch(a){let e=Date.now()-t;return console.error("[Cron] Health check failed:",a),h.Rc.captureException(a,{extra:{duration:e,context:"health_check_cron"},tags:{job:"health_check",severity:"high"}}),i.NextResponse.json({status:"unhealthy",error:"Health check system failure",message:a.message,timestamp:new Date().toISOString()},{status:500})}}async function w(){return i.NextResponse.json({error:"Method not allowed"},{status:405})}async function v(){return i.NextResponse.json({error:"Method not allowed"},{status:405})}async function f(){return i.NextResponse.json({error:"Method not allowed"},{status:405})}let T=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/cron/health-check/route",pathname:"/api/cron/health-check",filename:"route",bundlePath:"app/api/cron/health-check/route"},resolvedPagePath:"/Users/davicho/MASTER proyectos/FacePay/src/app/api/cron/health-check/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:x,staticGenerationAsyncStorage:D,serverHooks:E}=T,S="/api/cron/health-check/route";function _(){return(0,o.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:D})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,7],()=>a(67055));module.exports=r})();