"use strict";(()=>{var e={};e.id=3776,e.ids=[3776],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},56200:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>v,patchFetch:()=>x,requestAsyncStorage:()=>b,routeModule:()=>T,serverHooks:()=>R,staticGenerationAsyncStorage:()=>k});var r={};n.r(r),n.d(r,{GET:()=>p,dynamic:()=>l});var a=n(49303),o=n(88716),s=n(60670),u=n(13538),i=n(2095),c=n(91585),d=n(26033);let l="force-dynamic",m=c.Ry({period:c.Km(["7d","30d","90d","1y","all"]).optional().default("30d"),granularity:c.Km(["day","week","month"]).optional().default("day"),timezone:c.Z_().optional().default("UTC"),includeRefunds:c.Z_().optional().default("true"),currency:c.Z_().optional()});async function p(e){try{let t=await (0,i.mk)(e);if(t.error)return t.error;let n=new URL(e.url),r=Object.fromEntries(n.searchParams.entries()),{period:a,granularity:o,timezone:s,includeRefunds:u,currency:c}=m.parse(r),d=new Date,l=function(e,t){let n=new Date(t);switch(e){case"7d":n.setDate(n.getDate()-7);break;case"30d":n.setDate(n.getDate()-30);break;case"90d":n.setDate(n.getDate()-90);break;case"1y":n.setFullYear(n.getFullYear()-1);break;case"all":n.setFullYear(2020)}return n}(a,d),p={userId:t.user.userId,createdAt:{gte:l,lte:d},...c&&{currency:c.toUpperCase()}},[T,b,k,R,v,x]=await Promise.all([f(p,"true"===u),y(p,o,l,d),h(p),g(p),A(p,10),w(p)]),M={period:a,dateRange:{start:l.toISOString(),end:d.toISOString()},overview:T,timeSeries:b,paymentMethods:k,status:R,topTransactions:v,failures:x,generated:new Date().toISOString()};return(0,i.x_)(M)}catch(e){if(e instanceof d.jm)return(0,i.jl)(e.errors[0].message,400);return console.error("Payment analytics error:",e),(0,i.jl)("Internal server error",500)}}async function f(e,t){let n=(await u._B.transaction.findMany({where:e,select:{amount:!0,status:!0,currency:!0,metadata:!0}})).reduce((e,n)=>{let r=n.metadata,a="refunded"===n.status&&r?.refund?r.refund.refundAmount:0;switch(e.totalTransactions+=1,e.totalAmount+=Number(n.amount),n.status){case"completed":e.completedTransactions+=1,e.completedAmount+=Number(n.amount);break;case"pending":e.pendingTransactions+=1,e.pendingAmount+=Number(n.amount);break;case"failed":e.failedTransactions+=1;break;case"refunded":e.refundedTransactions+=1,e.refundedAmount+=a||Number(n.amount),t&&(e.netAmount-=a||Number(n.amount))}return e},{totalTransactions:0,totalAmount:0,completedTransactions:0,completedAmount:0,pendingTransactions:0,pendingAmount:0,failedTransactions:0,refundedTransactions:0,refundedAmount:0,netAmount:0});n.netAmount=n.completedAmount-(t?n.refundedAmount:0);let r=n.totalTransactions>0?n.completedTransactions/n.totalTransactions*100:0,a=n.totalTransactions>0?n.failedTransactions/n.totalTransactions*100:0,o=n.totalTransactions>0?n.refundedTransactions/n.totalTransactions*100:0,s=n.totalTransactions>0?n.totalAmount/n.totalTransactions:0;return{...n,metrics:{completionRate:Math.round(100*r)/100,failureRate:Math.round(100*a)/100,refundRate:Math.round(100*o)/100,averageTransactionAmount:Math.round(100*s)/100}}}async function y(e,t,n,r){let a=await u._B.transaction.findMany({where:e,select:{amount:!0,status:!0,createdAt:!0,completedAt:!0,metadata:!0},orderBy:{createdAt:"asc"}});return(function(e,t,n){let r=[],a=new Date(e);for(;a<t;){let e=new Date(a),o=new Date(a);switch(n){case"day":o.setDate(o.getDate()+1);break;case"week":o.setDate(o.getDate()+7);break;case"month":o.setMonth(o.getMonth()+1)}r.push({start:e,end:o>t?t:o,label:function(e,t){switch(t){case"day":default:return e.toISOString().split("T")[0];case"week":let n=new Date(e);return n.setDate(e.getDate()-e.getDay()),`${n.toISOString().split("T")[0]} (Week)`;case"month":return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`}}(e,n)}),a.setTime(o.getTime())}return r})(n,r,t).map(e=>{let t=a.filter(t=>{let n=new Date(t.createdAt);return n>=e.start&&n<e.end}).reduce((e,t)=>{let n=t.metadata,r="refunded"===t.status&&n?.refund?n.refund.refundAmount:0;switch(e.total+=1,e.totalAmount+=Number(t.amount),t.status){case"completed":e.completed+=1,e.completedAmount+=Number(t.amount);break;case"pending":e.pending+=1;break;case"failed":e.failed+=1;break;case"refunded":e.refunded+=1,e.refundedAmount+=r||Number(t.amount)}return e},{total:0,totalAmount:0,completed:0,completedAmount:0,pending:0,failed:0,refunded:0,refundedAmount:0});return{date:e.label,timestamp:e.start.toISOString(),...t,netAmount:t.completedAmount-t.refundedAmount}})}async function h(e){let t=await u._B.transaction.groupBy({by:["paymentMethodId"],where:e,_count:{id:!0},_sum:{amount:!0},_avg:{amount:!0}}),n=await u._B.paymentMethod.findMany({where:{id:{in:t.map(e=>e.paymentMethodId)}},select:{id:!0,type:!0,provider:!0}});return t.map(e=>{let t=n.find(t=>t.id===e.paymentMethodId);return{paymentMethodId:e.paymentMethodId,type:t?.type||"unknown",provider:t?.provider||"unknown",transactionCount:e._count.id,totalAmount:e._sum.amount||0,averageAmount:Math.round(100*(Number(e._avg.amount)||0))/100}}).sort((e,t)=>Number(t.totalAmount)-Number(e.totalAmount))}async function g(e){return await u._B.transaction.groupBy({by:["status"],where:e,_count:{id:!0},_sum:{amount:!0}})}async function A(e,t){return await u._B.transaction.findMany({where:e,include:{paymentMethod:{select:{type:!0,provider:!0}}},orderBy:{amount:"desc"},take:t})}async function w(e){let t=await u._B.transaction.findMany({where:{...e,status:"failed"},select:{id:!0,amount:!0,createdAt:!0,metadata:!0,paymentMethodId:!0}}),n={},r=0;return t.forEach(e=>{r+=Number(e.amount);let t=e.metadata,a=t?.failureReason||t?.error||"Unknown";n[a]=(n[a]||0)+1}),{totalFailures:t.length,totalFailedAmount:r,failureReasons:Object.entries(n).map(([e,t])=>({reason:e,count:t})).sort((e,t)=>t.count-e.count),recentFailures:t.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()).slice(0,5)}}let T=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/payments/analytics/route",pathname:"/api/payments/analytics",filename:"route",bundlePath:"app/api/payments/analytics/route"},resolvedPagePath:"/Users/davicho/MASTER proyectos/FacePay/src/app/api/payments/analytics/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:b,staticGenerationAsyncStorage:k,serverHooks:R}=T,v="/api/payments/analytics/route";function x(){return(0,s.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:k})}},2095:(e,t,n)=>{n.d(t,{jl:()=>u,mk:()=>s,x_:()=>i});var r=n(87070),a=n(75183),o=n(13538);async function s(e){let t=e.headers.get("authorization"),n=(0,a.oA)(t);if(!n)return{user:null,error:r.NextResponse.json({success:!1,error:"Authorization token required"},{status:401})};let s=(0,a.ez)(n);return s?await o._B.user.findUnique({where:{id:s.userId}})?{user:s,error:null}:{user:null,error:r.NextResponse.json({success:!1,error:"User not found"},{status:401})}:{user:null,error:r.NextResponse.json({success:!1,error:"Invalid or expired token"},{status:401})}}function u(e,t=400){return r.NextResponse.json({success:!1,error:e},{status:t})}function i(e,t){return r.NextResponse.json({success:!0,data:e,message:t})}},75183:(e,t,n)=>{n.d(t,{X8:()=>u,ez:()=>i,oA:()=>d,si:()=>c});var r=n(41482),a=n.n(r);let o=process.env.JWT_SECRET||"your-secret-key",s=process.env.JWT_REFRESH_SECRET||"your-refresh-secret-key";function u(e){let t={userId:e.id,email:e.email};return{accessToken:a().sign(t,o,{expiresIn:"15m"}),refreshToken:a().sign(t,s,{expiresIn:"7d"}),expiresIn:900}}function i(e){try{return a().verify(e,o)}catch(e){return null}}function c(e){try{return a().verify(e,s)}catch(e){return null}}function d(e){return e&&e.startsWith("Bearer ")?e.substring(7):null}},13538:(e,t,n)=>{n.d(t,{_B:()=>s});var r=n(53524);let a=globalThis,o=process.env.DATABASE_URL,s=a.prisma??=new r.PrismaClient({log:["error","warn"],datasources:{db:{url:o}},...!1,errorFormat:"minimal"});s.$on("query",e=>{e.duration>1e3&&console.warn(`[SLOW QUERY] ${e.duration}ms: ${e.query}`)}),s.$on("error",e=>{console.error("[PRISMA ERROR]:",e)}),process.on("beforeExit",async()=>{await s.$disconnect()}),process.on("SIGINT",async()=>{await s.$disconnect(),process.exit(0)}),process.on("SIGTERM",async()=>{await s.$disconnect(),process.exit(0)})}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[8948,5972,1482,1585],()=>n(56200));module.exports=r})();