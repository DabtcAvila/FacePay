"use strict";(()=>{var e={};e.id=6048,e.ids=[6048],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},73837:e=>{e.exports=require("util")},94812:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>O,patchFetch:()=>q,requestAsyncStorage:()=>S,routeModule:()=>A,serverHooks:()=>j,staticGenerationAsyncStorage:()=>E});var n={};r.r(n),r.d(n,{POST:()=>I,dynamic:()=>f});var a=r(49303),o=r(88716),s=r(60670),i=r(87070),c=r(13538),d=r(62065),u=r(89557),l=r(60526),p=r(98682),m=r(48472),y=r(88757);let f="force-dynamic",h=new m.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"}),_=process.env.STRIPE_WEBHOOK_SECRET;async function g(e){try{let t;let r=await e.text(),n=(0,y.headers)().get("stripe-signature");if(!n)return console.error("No stripe signature found"),(0,u.Lu)(e,"Webhook request without Stripe signature",void 0,u.V6.HIGH),new i.NextResponse("No signature",{status:400});let a=function(e){let t=e.headers.get("x-forwarded-for"),r=e.headers.get("x-real-ip"),n=e.headers.get("x-connecting-ip");return t?t.split(",")[0].trim():r||n||"unknown"}(e);"unknown"===a||["54.187.174.","54.187.205.","54.187.216.","54.241.31.","52.14.14.","52.89.214.","54.148.220.","54.241.32."].some(e=>a.startsWith(e))||(console.warn("Webhook from non-Stripe IP:",a),(0,u.Lu)(e,`Webhook from suspicious IP: ${a}`,void 0,u.V6.MEDIUM));try{t=h.webhooks.constructEvent(r,n,_)}catch(t){return console.error("Webhook signature verification failed:",t),(0,u.Lu)(e,`Invalid webhook signature: ${t}`,void 0,u.V6.HIGH),new i.NextResponse("Invalid signature",{status:400})}switch(console.log("Received webhook event:",t.type),t.type){case"checkout.session.completed":await w(t.data.object);break;case"payment_intent.succeeded":await b(t.data.object);break;case"payment_intent.payment_failed":await k(t.data.object);break;case"payment_method.attached":await v(t.data.object);break;case"customer.created":await P(t.data.object);break;case"invoice.payment_succeeded":await x(t.data.object);break;case"invoice.payment_failed":await M(t.data.object);break;default:console.log("Unhandled event type:",t.type)}return new i.NextResponse("Webhook received",{status:200})}catch(t){return console.error("Webhook processing error:",t),(0,u.Lu)(e,`Webhook processing error: ${t}`,void 0,u.V6.MEDIUM),new i.NextResponse("Webhook error",{status:500})}}async function w(e){try{console.log("Processing checkout session completed:",e.id);let t=await c._B.transaction.findFirst({where:{metadata:{path:["stripeSessionId"],equals:e.id}}});if(!t){console.error("Transaction not found for session:",e.id);return}if(await c._B.transaction.update({where:{id:t.id},data:{status:"completed",completedAt:new Date,metadata:{...t.metadata,paymentIntentId:"string"==typeof e.payment_intent?e.payment_intent:e.payment_intent?.id||null,customerId:"string"==typeof e.customer?e.customer:e.customer?.id||null,paymentStatus:e.payment_status}}}),e.setup_intent&&e.customer){let r=await h.setupIntents.retrieve(e.setup_intent);r.payment_method&&await R(t.userId,r.payment_method,e.customer)}console.log("Transaction updated successfully:",t.id)}catch(e){console.error("Error handling checkout session completed:",e)}}async function b(e){let t=Date.now();try{console.log("Processing payment intent succeeded:",e.id);let r=await c._B.transaction.findMany({where:{metadata:{path:["stripePaymentIntentId"],equals:e.id}},include:{user:{select:{id:!0,email:!0,name:!0}},paymentMethod:{select:{id:!0,type:!0,provider:!0}}}});if(0===r.length){console.warn("No transactions found for payment intent:",e.id);return}for(let n of(await c._B.transaction.updateMany({where:{metadata:{path:["stripePaymentIntentId"],equals:e.id}},data:{status:"completed",completedAt:new Date}}),r)){let r={user_id:n.userId,transaction_id:n.id,payment_intent_id:e.id,amount:Number(n.amount),currency:n.currency,payment_method:e.payment_method?.toString()||"unknown",payment_method_type:n.paymentMethod?.type||"unknown",completion_timestamp:new Date().toISOString(),processing_time_ms:Date.now()-t};l.co.trackFunnelStep(l.T7.PAYMENT,"payment_completed",5,{...r,success:!0}),l.co.track(l.FP.PAYMENT_COMPLETED,{...r,revenue:Number(n.amount)}),l.co.trackPayment(Number(n.amount),n.currency,n.paymentMethod?.type||"stripe",!0,{transaction_id:n.id,payment_intent_id:e.id,payment_method_id:n.paymentMethodId,completion_timestamp:new Date().toISOString()}),n.user&&(l.co.identify(n.user.id,{email:n.user.email,name:n.user.name,last_payment_date:new Date().toISOString(),last_payment_amount:Number(n.amount),last_payment_currency:n.currency}),p.Rc.setUser({id:n.user.id,email:n.user.email||"",username:n.user.name||n.user.email||""})),p.Rc.addBreadcrumb(`Payment completed successfully: ${e.id}`,"payment","info",{userId:n.userId,transactionId:n.id,paymentIntentId:e.id,amount:Number(n.amount),currency:n.currency,paymentMethod:n.paymentMethod?.type}),n.paymentMethod&&l.co.trackFeatureUsage("payment_methods","successful_payment",{user_id:n.userId,payment_method_id:n.paymentMethod.id,payment_method_type:n.paymentMethod.type,provider:n.paymentMethod.provider,amount:Number(n.amount)}),console.log(`Payment completion tracked for transaction: ${n.id}`)}p.Rc.trackPerformanceMetric("payment_webhook_processing",Date.now()-t,{success:!0,payment_intent_id:e.id,transactions_count:r.length}),console.log("Payment intent transaction updated:",e.id)}catch(n){let r=Date.now()-t;l.co.track("Payment Webhook Error",{reason:"processing_error",payment_intent_id:e.id,error_message:n.message,webhook_type:"payment_intent.succeeded"}),p.Rc.captureException(n,{extra:{context:"payment_webhook_processing",payment_intent_id:e.id,webhook_type:"payment_intent.succeeded",duration:r},tags:{endpoint:"/api/payments/stripe/webhook",operation:"payment_intent_succeeded"}}),console.error("Error handling payment intent succeeded:",n)}}async function k(e){let t=Date.now();try{console.log("Processing payment intent failed:",e.id);let r=await c._B.transaction.findMany({where:{metadata:{path:["stripePaymentIntentId"],equals:e.id}},include:{user:{select:{id:!0,email:!0,name:!0}},paymentMethod:{select:{id:!0,type:!0,provider:!0}}}});for(let t of(await c._B.transaction.updateMany({where:{metadata:{path:["stripePaymentIntentId"],equals:e.id}},data:{status:"failed",metadata:{path:["errorMessage"],equals:e.last_payment_error?.message||"Payment failed"}}}),r)){let r={user_id:t.userId,transaction_id:t.id,payment_intent_id:e.id,amount:Number(t.amount),currency:t.currency,payment_method:e.payment_method?.toString()||"unknown",payment_method_type:t.paymentMethod?.type||"unknown",error_code:e.last_payment_error?.code||"unknown",error_message:e.last_payment_error?.message||"Payment failed",failure_timestamp:new Date().toISOString()};l.co.track(l.FP.PAYMENT_FAILED,{...r,revenue:0}),l.co.trackPayment(Number(t.amount),t.currency,t.paymentMethod?.type||"stripe",!1,{transaction_id:t.id,payment_intent_id:e.id,payment_method_id:t.paymentMethodId,error_code:e.last_payment_error?.code,error_message:e.last_payment_error?.message,failure_timestamp:new Date().toISOString()}),p.Rc.addBreadcrumb(`Payment failed: ${e.id}`,"payment","error",{userId:t.userId,transactionId:t.id,paymentIntentId:e.id,amount:Number(t.amount),currency:t.currency,errorCode:e.last_payment_error?.code,errorMessage:e.last_payment_error?.message}),p.Rc.captureMessage(`Payment failed: ${e.last_payment_error?.message||"Unknown error"}`,"warning",{extra:{user_id:t.userId,transaction_id:t.id,payment_intent_id:e.id,amount:Number(t.amount),currency:t.currency,error_code:e.last_payment_error?.code,error_type:e.last_payment_error?.type,decline_code:e.last_payment_error?.decline_code},tags:{payment_failure:!0,error_code:e.last_payment_error?.code||"unknown"}}),console.log(`Payment failure tracked for transaction: ${t.id}`)}p.Rc.trackPerformanceMetric("payment_failure_webhook_processing",Date.now()-t,{success:!0,payment_intent_id:e.id,transactions_count:r.length}),console.log("Failed payment intent transaction updated:",e.id)}catch(n){let r=Date.now()-t;l.co.track("Payment Webhook Error",{reason:"processing_error",payment_intent_id:e.id,error_message:n.message,webhook_type:"payment_intent.payment_failed"}),p.Rc.captureException(n,{extra:{context:"payment_failure_webhook_processing",payment_intent_id:e.id,webhook_type:"payment_intent.payment_failed",duration:r},tags:{endpoint:"/api/payments/stripe/webhook",operation:"payment_intent_failed"}}),console.error("Error handling payment intent failed:",n)}}async function v(e){try{if(console.log("Processing payment method attached:",e.id),!e.customer)return;let t=await h.customers.retrieve(e.customer);if(!t||t.deleted)return;let r=t.metadata?.userId;if(!r)return;await R(r,e.id,e.customer)}catch(e){console.error("Error handling payment method attached:",e)}}async function P(e){try{console.log("Processing customer created:",e.id),e.metadata?.userId&&console.log("Customer created for user:",e.metadata.userId)}catch(e){console.error("Error handling customer created:",e)}}async function x(e){try{console.log("Processing invoice payment succeeded:",e.id)}catch(e){console.error("Error handling invoice payment succeeded:",e)}}async function M(e){try{console.log("Processing invoice payment failed:",e.id)}catch(e){console.error("Error handling invoice payment failed:",e)}}async function R(e,t,r){try{let n=await h.paymentMethods.retrieve(t),a=await c._B.paymentMethod.findFirst({where:{userId:e,details:{path:["stripePaymentMethodId"],equals:t}}});if(a)return a;let o=await c._B.paymentMethod.create({data:{userId:e,type:n.type,provider:"stripe",details:{stripePaymentMethodId:t,stripeCustomerId:r,type:n.type,...n.card&&{card:{brand:n.card.brand,last4:n.card.last4,expMonth:n.card.exp_month,expYear:n.card.exp_year}}}}});return console.log("Payment method saved:",o.id),o}catch(e){console.error("Error saving payment method:",e)}}let I=(0,d.bY)(g),A=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/payments/stripe/webhook/route",pathname:"/api/payments/stripe/webhook",filename:"route",bundlePath:"app/api/payments/stripe/webhook/route"},resolvedPagePath:"/Users/davicho/MASTER proyectos/FacePay/src/app/api/payments/stripe/webhook/route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:S,staticGenerationAsyncStorage:E,serverHooks:j}=A,O="/api/payments/stripe/webhook/route";function q(){return(0,s.patchFetch)({serverHooks:j,staticGenerationAsyncStorage:E})}},33085:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"DraftMode",{enumerable:!0,get:function(){return o}});let n=r(45869),a=r(6278);class o{get isEnabled(){return this._provider.isEnabled}enable(){let e=n.staticGenerationAsyncStorage.getStore();return e&&(0,a.trackDynamicDataAccessed)(e,"draftMode().enable()"),this._provider.enable()}disable(){let e=n.staticGenerationAsyncStorage.getStore();return e&&(0,a.trackDynamicDataAccessed)(e,"draftMode().disable()"),this._provider.disable()}constructor(e){this._provider=e}}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},88757:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{cookies:function(){return p},draftMode:function(){return m},headers:function(){return l}});let n=r(68996),a=r(53047),o=r(92044),s=r(72934),i=r(33085),c=r(6278),d=r(45869),u=r(54580);function l(){let e="headers",t=d.staticGenerationAsyncStorage.getStore();if(t){if(t.forceStatic)return a.HeadersAdapter.seal(new Headers({}));(0,c.trackDynamicDataAccessed)(t,e)}return(0,u.getExpectedRequestStore)(e).headers}function p(){let e="cookies",t=d.staticGenerationAsyncStorage.getStore();if(t){if(t.forceStatic)return n.RequestCookiesAdapter.seal(new o.RequestCookies(new Headers({})));(0,c.trackDynamicDataAccessed)(t,e)}let r=(0,u.getExpectedRequestStore)(e),a=s.actionAsyncStorage.getStore();return(null==a?void 0:a.isAction)||(null==a?void 0:a.isAppRoute)?r.mutableCookies:r.cookies}function m(){let e=(0,u.getExpectedRequestStore)("draftMode");return new i.DraftMode(e.draftMode)}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},53047:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{HeadersAdapter:function(){return o},ReadonlyHeadersError:function(){return a}});let n=r(38238);class a extends Error{constructor(){super("Headers cannot be modified. Read more: https://nextjs.org/docs/app/api-reference/functions/headers")}static callable(){throw new a}}class o extends Headers{constructor(e){super(),this.headers=new Proxy(e,{get(t,r,a){if("symbol"==typeof r)return n.ReflectAdapter.get(t,r,a);let o=r.toLowerCase(),s=Object.keys(e).find(e=>e.toLowerCase()===o);if(void 0!==s)return n.ReflectAdapter.get(t,s,a)},set(t,r,a,o){if("symbol"==typeof r)return n.ReflectAdapter.set(t,r,a,o);let s=r.toLowerCase(),i=Object.keys(e).find(e=>e.toLowerCase()===s);return n.ReflectAdapter.set(t,i??r,a,o)},has(t,r){if("symbol"==typeof r)return n.ReflectAdapter.has(t,r);let a=r.toLowerCase(),o=Object.keys(e).find(e=>e.toLowerCase()===a);return void 0!==o&&n.ReflectAdapter.has(t,o)},deleteProperty(t,r){if("symbol"==typeof r)return n.ReflectAdapter.deleteProperty(t,r);let a=r.toLowerCase(),o=Object.keys(e).find(e=>e.toLowerCase()===a);return void 0===o||n.ReflectAdapter.deleteProperty(t,o)}})}static seal(e){return new Proxy(e,{get(e,t,r){switch(t){case"append":case"delete":case"set":return a.callable;default:return n.ReflectAdapter.get(e,t,r)}}})}merge(e){return Array.isArray(e)?e.join(", "):e}static from(e){return e instanceof Headers?e:new o(e)}append(e,t){let r=this.headers[e];"string"==typeof r?this.headers[e]=[r,t]:Array.isArray(r)?r.push(t):this.headers[e]=t}delete(e){delete this.headers[e]}get(e){let t=this.headers[e];return void 0!==t?this.merge(t):null}has(e){return void 0!==this.headers[e]}set(e,t){this.headers[e]=t}forEach(e,t){for(let[r,n]of this.entries())e.call(t,n,r,this)}*entries(){for(let e of Object.keys(this.headers)){let t=e.toLowerCase(),r=this.get(t);yield[t,r]}}*keys(){for(let e of Object.keys(this.headers)){let t=e.toLowerCase();yield t}}*values(){for(let e of Object.keys(this.headers)){let t=this.get(e);yield t}}[Symbol.iterator](){return this.entries()}}},38238:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"ReflectAdapter",{enumerable:!0,get:function(){return r}});class r{static get(e,t,r){let n=Reflect.get(e,t,r);return"function"==typeof n?n.bind(e):n}static set(e,t,r,n){return Reflect.set(e,t,r,n)}static has(e,t){return Reflect.has(e,t)}static deleteProperty(e,t){return Reflect.deleteProperty(e,t)}}},68996:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{MutableRequestCookiesAdapter:function(){return l},ReadonlyRequestCookiesError:function(){return s},RequestCookiesAdapter:function(){return i},appendMutableCookies:function(){return u},getModifiedCookieValues:function(){return d}});let n=r(92044),a=r(38238),o=r(45869);class s extends Error{constructor(){super("Cookies can only be modified in a Server Action or Route Handler. Read more: https://nextjs.org/docs/app/api-reference/functions/cookies#cookiessetname-value-options")}static callable(){throw new s}}class i{static seal(e){return new Proxy(e,{get(e,t,r){switch(t){case"clear":case"delete":case"set":return s.callable;default:return a.ReflectAdapter.get(e,t,r)}}})}}let c=Symbol.for("next.mutated.cookies");function d(e){let t=e[c];return t&&Array.isArray(t)&&0!==t.length?t:[]}function u(e,t){let r=d(t);if(0===r.length)return!1;let a=new n.ResponseCookies(e),o=a.getAll();for(let e of r)a.set(e);for(let e of o)a.set(e);return!0}class l{static wrap(e,t){let r=new n.ResponseCookies(new Headers);for(let t of e.getAll())r.set(t);let s=[],i=new Set,d=()=>{let e=o.staticGenerationAsyncStorage.getStore();if(e&&(e.pathWasRevalidated=!0),s=r.getAll().filter(e=>i.has(e.name)),t){let e=[];for(let t of s){let r=new n.ResponseCookies(new Headers);r.set(t),e.push(r.toString())}t(e)}};return new Proxy(r,{get(e,t,r){switch(t){case c:return s;case"delete":return function(...t){i.add("string"==typeof t[0]?t[0]:t[0].name);try{e.delete(...t)}finally{d()}};case"set":return function(...t){i.add("string"==typeof t[0]?t[0]:t[0].name);try{return e.set(...t)}finally{d()}};default:return a.ReflectAdapter.get(e,t,r)}}})}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[8948,5972,8472,7,5120],()=>r(94812));module.exports=n})();