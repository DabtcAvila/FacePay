"use strict";(()=>{var e={};e.id=9959,e.ids=[9959],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},79056:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>k,patchFetch:()=>A,requestAsyncStorage:()=>x,routeModule:()=>I,serverHooks:()=>v,staticGenerationAsyncStorage:()=>w});var n={};r.r(n),r.d(n,{POST:()=>f,dynamic:()=>g});var a=r(49303),s=r(88716),o=r(60670),i=r(13538),u=r(2095),c=r(91585),d=r(26033);let l=c.Ry({operation:c.Km(["refund","cancel","export"]),transactionIds:c.IX(c.Z_()).min(1,"At least one transaction ID required"),params:c.IM(c.Yj()).optional()}),p=c.Ry({format:c.Km(["csv","json"]).default("csv"),includeRefunded:c.O7().default(!0),includeMetadata:c.O7().default(!1)});async function f(e){try{let t;let r=await (0,u.mk)(e);if(r.error)return r.error;let n=await e.json(),{operation:a,transactionIds:s,params:o}=l.parse(n),c=await i._B.transaction.findMany({where:{id:{in:s},userId:r.user.userId},include:{paymentMethod:{select:{id:!0,type:!0,provider:!0,details:!0}},user:{select:{id:!0,email:!0,name:!0}}}});if(c.length!==s.length)return(0,u.jl)("Some transactions not found or do not belong to you",404);switch(a){case"refund":t=await m(c,o);break;case"cancel":t=await y(c,o);break;case"export":let d=p.parse(o||{});t=await h(c,d);break;default:return(0,u.jl)("Invalid operation",400)}return(0,u.x_)(t,`Bulk ${a} completed`)}catch(e){if(e instanceof d.jm)return(0,u.jl)(e.errors[0].message,400);return console.error("Bulk operation error:",e),(0,u.jl)("Internal server error",500)}}async function m(e,t){let r={successful:[],failed:[]},n=t?.reason||"Bulk refund operation";for(let t of e)try{if("completed"!==t.status){r.failed.push({transactionId:t.id,reason:`Transaction status is ${t.status}, only completed transactions can be refunded`});continue}let e={refundAmount:t.amount,reason:n,refundedAt:new Date().toISOString(),refundedBy:t.userId,originalAmount:t.amount,bulkOperation:!0};await i._B.transaction.update({where:{id:t.id},data:{status:"refunded",metadata:{...t.metadata||{},refund:e}}}),r.successful.push({transactionId:t.id,refundAmount:t.amount,refundId:`refund_${t.id}_${Date.now()}`})}catch(e){r.failed.push({transactionId:t.id,reason:e instanceof Error?e.message:"Unknown error"})}return{operation:"refund",processed:e.length,successful:r.successful.length,failed:r.failed.length,results:r}}async function y(e,t){let r={successful:[],failed:[]},n=t?.reason||"Bulk cancellation operation";for(let t of e)try{if("pending"!==t.status){r.failed.push({transactionId:t.id,reason:`Transaction status is ${t.status}, only pending transactions can be cancelled`});continue}await i._B.transaction.update({where:{id:t.id},data:{status:"failed",metadata:{...t.metadata||{},cancellation:{reason:n,cancelledAt:new Date().toISOString(),cancelledBy:t.userId,bulkOperation:!0}}}}),r.successful.push({transactionId:t.id,cancelledAt:new Date().toISOString()})}catch(e){r.failed.push({transactionId:t.id,reason:e instanceof Error?e.message:"Unknown error"})}return{operation:"cancel",processed:e.length,successful:r.successful.length,failed:r.failed.length,results:r}}async function h(e,t){let{format:r,includeRefunded:n,includeMetadata:a}=t,s=e;n||(s=e.filter(e=>"refunded"!==e.status));let o=s.map(e=>{let t=e.metadata||{},r=t.refund,n={transactionId:e.id,date:e.createdAt,completedAt:e.completedAt,amount:e.amount,currency:e.currency,status:e.status,description:e.description,customerName:e.user.name,customerEmail:e.user.email,paymentType:e.paymentMethod.type,paymentProvider:e.paymentMethod.provider};return r&&Object.assign(n,{refundAmount:r.refundAmount,refundReason:r.reason,refundedAt:r.refundedAt}),a&&Object.assign(n,{metadata:JSON.stringify(t)}),n});if("csv"===r){let e=function(e){if(0===e.length)return"";let t=Object.keys(e[0]);return[t.join(","),...e.map(e=>t.map(t=>{let r=e[t];return null==r?"":"string"==typeof r&&(r.includes(",")||r.includes('"')||r.includes("\n"))?`"${r.replace(/"/g,'""')}"`:String(r)}).join(","))].join("\n")}(o);return{format:"csv",filename:`transactions_export_${new Date().toISOString().split("T")[0]}.csv`,data:e,recordCount:o.length}}return{format:"json",filename:`transactions_export_${new Date().toISOString().split("T")[0]}.json`,data:o,recordCount:o.length}}let g="force-dynamic",I=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/transactions/bulk/route",pathname:"/api/transactions/bulk",filename:"route",bundlePath:"app/api/transactions/bulk/route"},resolvedPagePath:"/Users/davicho/MASTER proyectos/FacePay/src/app/api/transactions/bulk/route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:x,staticGenerationAsyncStorage:w,serverHooks:v}=I,k="/api/transactions/bulk/route";function A(){return(0,o.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:w})}},2095:(e,t,r)=>{r.d(t,{jl:()=>i,mk:()=>o,x_:()=>u});var n=r(87070),a=r(75183),s=r(13538);async function o(e){let t=e.headers.get("authorization"),r=(0,a.oA)(t);if(!r)return{user:null,error:n.NextResponse.json({success:!1,error:"Authorization token required"},{status:401})};let o=(0,a.ez)(r);return o?await s._B.user.findUnique({where:{id:o.userId}})?{user:o,error:null}:{user:null,error:n.NextResponse.json({success:!1,error:"User not found"},{status:401})}:{user:null,error:n.NextResponse.json({success:!1,error:"Invalid or expired token"},{status:401})}}function i(e,t=400){return n.NextResponse.json({success:!1,error:e},{status:t})}function u(e,t){return n.NextResponse.json({success:!0,data:e,message:t})}},75183:(e,t,r)=>{r.d(t,{X8:()=>i,ez:()=>u,oA:()=>d,si:()=>c});var n=r(41482),a=r.n(n);let s=process.env.JWT_SECRET||"your-secret-key",o=process.env.JWT_REFRESH_SECRET||"your-refresh-secret-key";function i(e){let t={userId:e.id,email:e.email};return{accessToken:a().sign(t,s,{expiresIn:"15m"}),refreshToken:a().sign(t,o,{expiresIn:"7d"}),expiresIn:900}}function u(e){try{return a().verify(e,s)}catch(e){return null}}function c(e){try{return a().verify(e,o)}catch(e){return null}}function d(e){return e&&e.startsWith("Bearer ")?e.substring(7):null}},13538:(e,t,r)=>{r.d(t,{_B:()=>o});var n=r(53524);let a=globalThis,s=process.env.DATABASE_URL,o=a.prisma??=new n.PrismaClient({log:["error","warn"],datasources:{db:{url:s}},...!1,errorFormat:"minimal"});o.$on("query",e=>{e.duration>1e3&&console.warn(`[SLOW QUERY] ${e.duration}ms: ${e.query}`)}),o.$on("error",e=>{console.error("[PRISMA ERROR]:",e)}),process.on("beforeExit",async()=>{await o.$disconnect()}),process.on("SIGINT",async()=>{await o.$disconnect(),process.exit(0)}),process.on("SIGTERM",async()=>{await o.$disconnect(),process.exit(0)})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[8948,5972,1482,1585],()=>r(79056));module.exports=n})();