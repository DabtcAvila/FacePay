"use strict";(()=>{var e={};e.id=7196,e.ids=[7196],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},2207:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>A,requestAsyncStorage:()=>h,routeModule:()=>f,serverHooks:()=>w,staticGenerationAsyncStorage:()=>_});var n={};r.r(n),r.d(n,{GET:()=>m,dynamic:()=>l});var a=r(49303),o=r(88716),s=r(60670),u=r(13538),i=r(2095),d=r(91585),c=r(26033);let l="force-dynamic",p=d.Ry({page:d.Z_().optional().default("1"),limit:d.Z_().optional().default("20"),status:d.Km(["pending","completed","failed","refunded"]).optional(),paymentMethod:d.Z_().optional(),dateFrom:d.Z_().optional(),dateTo:d.Z_().optional(),amountMin:d.Z_().optional(),amountMax:d.Z_().optional(),search:d.Z_().optional(),sortBy:d.Km(["createdAt","completedAt","amount","status"]).optional().default("createdAt"),sortOrder:d.Km(["asc","desc"]).optional().default("desc"),includeAnalytics:d.Z_().optional().default("false")});async function m(e){try{let t=await (0,i.mk)(e);if(t.error)return t.error;let r=new URL(e.url),n=Object.fromEntries(r.searchParams.entries()),{page:a,limit:o,status:s,paymentMethod:d,dateFrom:c,dateTo:l,amountMin:m,amountMax:f,search:h,sortBy:_,sortOrder:w,includeAnalytics:x}=p.parse(n),A=parseInt(a),g=parseInt(o),v=(A-1)*g,R={userId:t.user.userId};s&&(R.status=s),(c||l)&&(R.createdAt={},c&&(R.createdAt.gte=new Date(c)),l&&(R.createdAt.lte=new Date(l))),(m||f)&&(R.amount={},m&&(R.amount.gte=parseFloat(m)),f&&(R.amount.lte=parseFloat(f))),h&&(R.description={contains:h,mode:"insensitive"}),d&&(R.paymentMethod={type:d});let[I,M]=await Promise.all([u._B.transaction.findMany({where:R,include:{paymentMethod:{select:{id:!0,type:!0,provider:!0,details:!0}}},orderBy:{[_]:w},skip:v,take:g}),u._B.transaction.count({where:R})]),b=Math.ceil(M/g),k={transactions:I.map(e=>({...e,isRefunded:"refunded"===e.status,refundInfo:"refunded"===e.status&&e.metadata?e.metadata.refund:null})),pagination:{page:A,limit:g,total:M,totalPages:b,hasNext:A<b,hasPrev:A>1},filters:{status:s,paymentMethod:d,dateFrom:c,dateTo:l,amountMin:m,amountMax:f,search:h}};if("true"===x){let e=await y(t.user.userId,R);k.analytics=e}return(0,i.x_)(k)}catch(e){if(e instanceof c.jm)return(0,i.jl)(e.errors[0].message,400);return console.error("Get transaction history error:",e),(0,i.jl)("Internal server error",500)}}async function y(e,t){try{let r={...t},n=await u._B.transaction.count({where:r}),a=await u._B.transaction.groupBy({by:["status"],where:r,_count:{id:!0},_sum:{amount:!0}}),o=await u._B.transaction.groupBy({by:["paymentMethodId"],where:r,_count:{id:!0},_sum:{amount:!0}}),s=await u._B.paymentMethod.findMany({where:{userId:e,id:{in:o.map(e=>e.paymentMethodId)}},select:{id:!0,type:!0,provider:!0}}),i=new Date;i.setMonth(i.getMonth()-12);let d=(await u._B.transaction.findMany({where:{...r,createdAt:{gte:i}},select:{amount:!0,status:!0,createdAt:!0}})).reduce((e,t)=>{let r=t.createdAt.toISOString().slice(0,7);return e[r]||(e[r]={total:0,count:0,completed:0,refunded:0}),e[r].total+=t.amount,e[r].count+=1,"completed"===t.status?e[r].completed+=t.amount:"refunded"===t.status&&(e[r].refunded+=t.amount),e},{}),c=a.reduce((e,t)=>e+Number(t._sum.amount||0),0),l=a.find(e=>"completed"===e.status)?._sum.amount||0,p=a.find(e=>"refunded"===e.status)?._sum.amount||0;return{summary:{totalTransactions:n,totalAmount:c,completedAmount:Number(l||0),refundedAmount:Number(p||0),netAmount:Number(l||0)-Number(p||0)},statusBreakdown:a.map(e=>({status:e.status,count:e._count.id,totalAmount:Number(e._sum.amount||0)})),paymentMethodBreakdown:o.map(e=>{let t=s.find(t=>t.id===e.paymentMethodId);return{paymentMethodId:e.paymentMethodId,type:t?.type||"unknown",provider:t?.provider||"unknown",count:e._count.id,totalAmount:Number(e._sum.amount||0)}}),monthlyBreakdown:Object.entries(d).sort(([e],[t])=>e.localeCompare(t)).map(([e,t])=>({month:e,...t})),trends:{averageTransactionAmount:c/n||0,refundRate:(a.find(e=>"refunded"===e.status)?._count.id||0)/n*100,completionRate:(a.find(e=>"completed"===e.status)?._count.id||0)/n*100}}}catch(e){return console.error("Analytics generation error:",e),null}}let f=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/transactions/history/route",pathname:"/api/transactions/history",filename:"route",bundlePath:"app/api/transactions/history/route"},resolvedPagePath:"/Users/davicho/MASTER proyectos/FacePay/src/app/api/transactions/history/route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:h,staticGenerationAsyncStorage:_,serverHooks:w}=f,x="/api/transactions/history/route";function A(){return(0,s.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:_})}},2095:(e,t,r)=>{r.d(t,{jl:()=>u,mk:()=>s,x_:()=>i});var n=r(87070),a=r(75183),o=r(13538);async function s(e){let t=e.headers.get("authorization"),r=(0,a.oA)(t);if(!r)return{user:null,error:n.NextResponse.json({success:!1,error:"Authorization token required"},{status:401})};let s=(0,a.ez)(r);return s?await o._B.user.findUnique({where:{id:s.userId}})?{user:s,error:null}:{user:null,error:n.NextResponse.json({success:!1,error:"User not found"},{status:401})}:{user:null,error:n.NextResponse.json({success:!1,error:"Invalid or expired token"},{status:401})}}function u(e,t=400){return n.NextResponse.json({success:!1,error:e},{status:t})}function i(e,t){return n.NextResponse.json({success:!0,data:e,message:t})}},75183:(e,t,r)=>{r.d(t,{X8:()=>u,ez:()=>i,oA:()=>c,si:()=>d});var n=r(41482),a=r.n(n);let o=process.env.JWT_SECRET||"your-secret-key",s=process.env.JWT_REFRESH_SECRET||"your-refresh-secret-key";function u(e){let t={userId:e.id,email:e.email};return{accessToken:a().sign(t,o,{expiresIn:"15m"}),refreshToken:a().sign(t,s,{expiresIn:"7d"}),expiresIn:900}}function i(e){try{return a().verify(e,o)}catch(e){return null}}function d(e){try{return a().verify(e,s)}catch(e){return null}}function c(e){return e&&e.startsWith("Bearer ")?e.substring(7):null}},13538:(e,t,r)=>{r.d(t,{_B:()=>s});var n=r(53524);let a=globalThis,o=process.env.DATABASE_URL,s=a.prisma??=new n.PrismaClient({log:["error","warn"],datasources:{db:{url:o}},...!1,errorFormat:"minimal"});s.$on("query",e=>{e.duration>1e3&&console.warn(`[SLOW QUERY] ${e.duration}ms: ${e.query}`)}),s.$on("error",e=>{console.error("[PRISMA ERROR]:",e)}),process.on("beforeExit",async()=>{await s.$disconnect()}),process.on("SIGINT",async()=>{await s.$disconnect(),process.exit(0)}),process.on("SIGTERM",async()=>{await s.$disconnect(),process.exit(0)})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[8948,5972,1482,1585],()=>r(2207));module.exports=n})();