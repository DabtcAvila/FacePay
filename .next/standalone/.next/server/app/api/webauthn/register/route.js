"use strict";(()=>{var e={};e.id=2235,e.ids=[2235],e.modules={53524:e=>{e.exports=require("@prisma/client")},3473:e=>{e.exports=require("@simplewebauthn/server")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},93141:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>k,requestAsyncStorage:()=>w,routeModule:()=>I,serverHooks:()=>R,staticGenerationAsyncStorage:()=>T});var i={};r.r(i),r.d(i,{POST:()=>m,dynamic:()=>b});var n=r(49303),a=r(88716),s=r(60670),o=r(13538),c=r(2095),d=r(3473),u=r(60526),l=r(98682),p=r(91585),_=r(26033);let f=p.Ry({action:p.i0("initiate")}),g=p.Ry({action:p.i0("verify"),credential:p.Ry({id:p.Z_(),rawId:p.Z_(),response:p.Ry({attestationObject:p.Z_(),clientDataJSON:p.Z_()}),type:p.i0("public-key"),clientExtensionResults:p.IM(p.Yj()).optional()})}),h=p.G0([f,g]);async function m(e){try{let t=await (0,c.mk)(e);if(t.error)return t.error;let r=await e.json(),i=h.parse(r),n=await o._B.user.findUnique({where:{id:t.user.userId},include:{webauthnCredentials:!0}});if(!n)return(0,c.jl)("User not found",404);if("initiate"===i.action)return await y(n);return await v(n,i.credential)}catch(e){if(e instanceof _.jm)return(0,c.jl)("Invalid request format: "+e.errors[0].message,400);return console.error("WebAuthn registration error:",e),(0,c.jl)("Failed to process registration request",500)}}async function y(e){let t=Date.now();try{u.co.trackFunnelStep(u.T7.BIOMETRIC_SETUP,"initiation_started",1,{user_id:e.id,existing_credentials_count:e.webauthnCredentials?.length||0,has_existing_biometric:e.webauthnCredentials?.length>0});let r=e.webauthnCredentials.map(e=>({id:e.credentialId,type:"public-key"})),i=await (0,d.generateRegistrationOptions)({rpName:process.env.WEBAUTHN_RP_NAME||"FacePay",rpID:process.env.WEBAUTHN_RP_ID||"localhost",userID:e.id,userName:e.email,userDisplayName:e.name||e.email,timeout:6e4,attestationType:"none",excludeCredentials:r,authenticatorSelection:{residentKey:"preferred",userVerification:"required",authenticatorAttachment:"platform"},supportedAlgorithmIDs:[-7,-257]});return await o._B.user.update({where:{id:e.id},data:{currentChallenge:i.challenge}}),u.co.trackFunnelStep(u.T7.BIOMETRIC_SETUP,"options_generated",2,{user_id:e.id,challenge_length:i.challenge.length,timeout:6e4,authenticator_attachment:"platform"}),u.co.trackFeatureUsage("webauthn","registration_options_generated",{user_id:e.id,generation_time_ms:Date.now()-t,excluded_credentials_count:r.length}),l.Rc.addBreadcrumb(`WebAuthn registration options generated for user ${e.id}`,"biometric_setup","info",{userId:e.id,challengeGenerated:!0,existingCredentials:r.length}),l.Rc.trackPerformanceMetric("webauthn_options_generation",Date.now()-t,{success:!0,excluded_credentials:r.length}),(0,c.x_)({options:i,userId:e.id},"Registration options generated successfully")}catch(i){let r=Date.now()-t;return u.co.track("Biometric Setup Failed",{reason:"options_generation_failed",user_id:e.id,error_message:i.message,funnel:u.T7.BIOMETRIC_SETUP,step:"options_generation"}),l.Rc.captureException(i,{extra:{context:"webauthn_registration_initiation",user_id:e.id,duration:r,existing_credentials_count:e.webauthnCredentials?.length||0},tags:{endpoint:"/api/webauthn/register",operation:"registration_initiation"}}),console.error("Failed to generate registration options:",i),(0,c.jl)("Failed to generate registration options",500)}}async function v(e,t){let r=Date.now();try{if(u.co.trackFunnelStep(u.T7.BIOMETRIC_SETUP,"verification_started",3,{user_id:e.id,credential_id:t.id,has_challenge:!!e.currentChallenge}),!e.currentChallenge)return u.co.track("Biometric Setup Failed",{reason:"no_active_challenge",user_id:e.id,funnel:u.T7.BIOMETRIC_SETUP,step:"verification"}),(0,c.jl)("No active registration challenge found",400);let i=await (0,d.verifyRegistrationResponse)({response:t,expectedChallenge:e.currentChallenge,expectedOrigin:process.env.WEBAUTHN_ORIGIN||"http://localhost:3000",expectedRPID:process.env.WEBAUTHN_RP_ID||"localhost",requireUserVerification:!0});if(!i.verified||!i.registrationInfo)return u.co.track("Biometric Setup Failed",{reason:"verification_failed",user_id:e.id,verification_result:i.verified,has_registration_info:!!i.registrationInfo,funnel:u.T7.BIOMETRIC_SETUP,step:"verification"}),l.Rc.addBreadcrumb(`WebAuthn verification failed for user ${e.id}`,"biometric_setup","warning",{userId:e.id,verified:i.verified}),(0,c.jl)("WebAuthn registration verification failed",400);let{credentialID:n,credentialPublicKey:a,counter:s,credentialBackedUp:p,credentialDeviceType:_}=i.registrationInfo;if(await o._B.webauthnCredential.findUnique({where:{credentialId:Buffer.from(n).toString("base64url")}}))return u.co.track("Biometric Setup Failed",{reason:"credential_already_exists",user_id:e.id,credential_id:Buffer.from(n).toString("base64url"),funnel:u.T7.BIOMETRIC_SETUP,step:"verification"}),(0,c.jl)("Credential already registered",409);let[f]=await o._B.$transaction([o._B.webauthnCredential.create({data:{userId:e.id,credentialId:Buffer.from(n).toString("base64url"),publicKey:Buffer.from(a).toString("base64url"),counter:s,backedUp:p,deviceType:_},select:{id:!0,credentialId:!0,backedUp:!0,deviceType:!0,createdAt:!0}}),o._B.user.update({where:{id:e.id},data:{currentChallenge:null}})]);await o._B.biometricData.create({data:{userId:e.id,type:"webauthn_passkey",data:"registered",isActive:!0}}),u.co.trackFunnelStep(u.T7.BIOMETRIC_SETUP,"registration_completed",4,{user_id:e.id,credential_id:f.credentialId,device_type:f.deviceType,backed_up:f.backedUp,completion_time_ms:Date.now()-r}),u.co.track(u.FP.BIOMETRIC_ENROLLED,{user_id:e.id,biometric_type:"webauthn_passkey",device_type:f.deviceType,backed_up:f.backedUp,enrollment_timestamp:f.createdAt}),u.co.trackUserRegistration("webauthn",{user_id:e.id,credential_id:f.credentialId,device_type:f.deviceType,backed_up:f.backedUp,completion_time_ms:Date.now()-r});let g=f.deviceType?.toLowerCase().includes("ios")?"face_id":"fingerprint";return u.co.trackBiometricAuth(g,!0,{user_id:e.id,operation:"registration",device_type:f.deviceType,webauthn_method:"platform_authenticator"}),l.Rc.addBreadcrumb(`WebAuthn registration completed successfully for user ${e.id}`,"biometric_setup","info",{userId:e.id,credentialId:f.credentialId,deviceType:f.deviceType,backedUp:f.backedUp}),l.Rc.trackPerformanceMetric("webauthn_registration_verification",Date.now()-r,{success:!0,device_type:f.deviceType,backed_up:f.backedUp}),(0,c.x_)({verified:!0,credential:{id:f.id,credentialId:f.credentialId,deviceType:f.deviceType,backedUp:f.backedUp,createdAt:f.createdAt}},"Biometric registration completed successfully")}catch(n){let i=Date.now()-r;return u.co.track("Biometric Setup Failed",{reason:"verification_system_error",user_id:e.id,error_message:n.message,funnel:u.T7.BIOMETRIC_SETUP,step:"verification"}),l.Rc.captureException(n,{extra:{context:"webauthn_registration_verification",user_id:e.id,credential_id:t.id,duration:i,has_challenge:!!e.currentChallenge},tags:{endpoint:"/api/webauthn/register",operation:"registration_verification"}}),console.error("Failed to verify registration:",n),(0,c.jl)("Failed to verify registration",500)}}let b="force-dynamic",I=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/webauthn/register/route",pathname:"/api/webauthn/register",filename:"route",bundlePath:"app/api/webauthn/register/route"},resolvedPagePath:"/Users/davicho/MASTER proyectos/FacePay/src/app/api/webauthn/register/route.ts",nextConfigOutput:"standalone",userland:i}),{requestAsyncStorage:w,staticGenerationAsyncStorage:T,serverHooks:R}=I,x="/api/webauthn/register/route";function k(){return(0,s.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:T})}},2095:(e,t,r)=>{r.d(t,{jl:()=>o,mk:()=>s,x_:()=>c});var i=r(87070),n=r(75183),a=r(13538);async function s(e){let t=e.headers.get("authorization"),r=(0,n.oA)(t);if(!r)return{user:null,error:i.NextResponse.json({success:!1,error:"Authorization token required"},{status:401})};let s=(0,n.ez)(r);return s?await a._B.user.findUnique({where:{id:s.userId}})?{user:s,error:null}:{user:null,error:i.NextResponse.json({success:!1,error:"User not found"},{status:401})}:{user:null,error:i.NextResponse.json({success:!1,error:"Invalid or expired token"},{status:401})}}function o(e,t=400){return i.NextResponse.json({success:!1,error:e},{status:t})}function c(e,t){return i.NextResponse.json({success:!0,data:e,message:t})}},75183:(e,t,r)=>{r.d(t,{X8:()=>o,ez:()=>c,oA:()=>u,si:()=>d});var i=r(41482),n=r.n(i);let a=process.env.JWT_SECRET||"your-secret-key",s=process.env.JWT_REFRESH_SECRET||"your-refresh-secret-key";function o(e){let t={userId:e.id,email:e.email};return{accessToken:n().sign(t,a,{expiresIn:"15m"}),refreshToken:n().sign(t,s,{expiresIn:"7d"}),expiresIn:900}}function c(e){try{return n().verify(e,a)}catch(e){return null}}function d(e){try{return n().verify(e,s)}catch(e){return null}}function u(e){return e&&e.startsWith("Bearer ")?e.substring(7):null}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[8948,5972,1482,1585,7],()=>r(93141));module.exports=i})();