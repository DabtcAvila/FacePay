"use strict";(()=>{var e={};e.id=9128,e.ids=[9128],e.modules={53524:e=>{e.exports=require("@prisma/client")},3473:e=>{e.exports=require("@simplewebauthn/server")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},39719:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>A,staticGenerationAsyncStorage:()=>b});var n={};r.r(n),r.d(n,{POST:()=>f,dynamic:()=>p});var i=r(49303),o=r(88716),s=r(60670),a=r(13538),u=r(2095),c=r(3473),l=r(91585),d=r(26033);let p="force-dynamic",h=l.Ry({email:l.Z_().email("Invalid email address").optional(),userId:l.Z_().optional()});async function f(e){try{let t=await e.json(),{email:r,userId:n}=h.parse(t);console.log("[WebAuthn Authentication Options] Starting biometric authentication:",{email:r||"not provided",userId:n||"not provided",timestamp:new Date().toISOString(),userAgent:e.headers.get("user-agent"),origin:e.headers.get("origin")});let i=[],o=null;if(r){if(!(o=await a._B.user.findUnique({where:{email:r},include:{webauthnCredentials:!0}})))return console.error("[WebAuthn Authentication Options] User not found by email:",r),(0,u.jl)("User not found",404);if(0===o.webauthnCredentials.length)return console.error("[WebAuthn Authentication Options] No credentials found for user:",r),(0,u.jl)("No biometric credentials found for this user. Please register your biometric data first.",404);i=o.webauthnCredentials.map(e=>({id:e.credentialId,type:"public-key",transports:e.transports||["internal"]})),console.log("[WebAuthn Authentication Options] Found credentials for user:",{email:r,credentialCount:i.length,deviceTypes:o.webauthnCredentials.map(e=>e.deviceType)})}else if(n){if(!(o=await a._B.user.findUnique({where:{id:n},include:{webauthnCredentials:!0}})))return console.error("[WebAuthn Authentication Options] User not found by ID:",n),(0,u.jl)("User not found",404);if(0===o.webauthnCredentials.length)return console.error("[WebAuthn Authentication Options] No credentials found for userId:",n),(0,u.jl)("No biometric credentials found for this user. Please register your biometric data first.",404);i=o.webauthnCredentials.map(e=>({id:e.credentialId,type:"public-key",transports:e.transports||["internal"]})),console.log("[WebAuthn Authentication Options] Found credentials for userId:",{userId:n,credentialCount:i.length,deviceTypes:o.webauthnCredentials.map(e=>e.deviceType)})}if(!o)return console.error("[WebAuthn Authentication Options] No user provided for authentication"),(0,u.jl)("Email or userId is required for biometric authentication",400);let s=await (0,c.generateAuthenticationOptions)({allowCredentials:i.map(e=>({id:e.id,type:"public-key",transports:e.transports})),userVerification:"required",rpID:process.env.WEBAUTHN_RP_ID||"localhost"});return await a._B.user.update({where:{id:o.id},data:{currentChallenge:s.challenge}}),console.log("[WebAuthn Authentication Options] Authentication options generated successfully:",{userId:o.id,email:o.email,credentialCount:i.length,challengeLength:s.challenge.length,biometricRequired:!0,platformAuthenticatorRequired:!0,timestamp:new Date().toISOString()}),(0,u.x_)({options:s,userId:o.id,hasCredentials:i.length>0,biometricRequired:!0,platformAuthenticatorRequired:!0,message:"Authentication options generated successfully"},"WebAuthn authentication options generated")}catch(t){if(t instanceof d.jm)return console.error("[WebAuthn Authentication Options] Invalid request format:",t.errors),(0,u.jl)("Invalid request format: "+t.errors[0].message,400);return console.error("[WebAuthn Authentication Options] Authentication options generation failed:",{error:t instanceof Error?t.message:String(t),stack:t instanceof Error?t.stack:void 0,timestamp:new Date().toISOString(),userAgent:e.headers.get("user-agent")}),(0,u.jl)("Failed to generate authentication options",500)}}let m=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/webauthn/authenticate/options/route",pathname:"/api/webauthn/authenticate/options",filename:"route",bundlePath:"app/api/webauthn/authenticate/options/route"},resolvedPagePath:"/Users/davicho/MASTER proyectos/FacePay/src/app/api/webauthn/authenticate/options/route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:g,staticGenerationAsyncStorage:b,serverHooks:A}=m,y="/api/webauthn/authenticate/options/route";function w(){return(0,s.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:b})}},2095:(e,t,r)=>{r.d(t,{jl:()=>a,mk:()=>s,x_:()=>u});var n=r(87070),i=r(75183),o=r(13538);async function s(e){let t=e.headers.get("authorization"),r=(0,i.oA)(t);if(!r)return{user:null,error:n.NextResponse.json({success:!1,error:"Authorization token required"},{status:401})};let s=(0,i.ez)(r);return s?await o._B.user.findUnique({where:{id:s.userId}})?{user:s,error:null}:{user:null,error:n.NextResponse.json({success:!1,error:"User not found"},{status:401})}:{user:null,error:n.NextResponse.json({success:!1,error:"Invalid or expired token"},{status:401})}}function a(e,t=400){return n.NextResponse.json({success:!1,error:e},{status:t})}function u(e,t){return n.NextResponse.json({success:!0,data:e,message:t})}},75183:(e,t,r)=>{r.d(t,{X8:()=>a,ez:()=>u,oA:()=>l,si:()=>c});var n=r(41482),i=r.n(n);let o=process.env.JWT_SECRET||"your-secret-key",s=process.env.JWT_REFRESH_SECRET||"your-refresh-secret-key";function a(e){let t={userId:e.id,email:e.email};return{accessToken:i().sign(t,o,{expiresIn:"15m"}),refreshToken:i().sign(t,s,{expiresIn:"7d"}),expiresIn:900}}function u(e){try{return i().verify(e,o)}catch(e){return null}}function c(e){try{return i().verify(e,s)}catch(e){return null}}function l(e){return e&&e.startsWith("Bearer ")?e.substring(7):null}},13538:(e,t,r)=>{r.d(t,{_B:()=>s});var n=r(53524);let i=globalThis,o=process.env.DATABASE_URL,s=i.prisma??=new n.PrismaClient({log:["error","warn"],datasources:{db:{url:o}},...!1,errorFormat:"minimal"});s.$on("query",e=>{e.duration>1e3&&console.warn(`[SLOW QUERY] ${e.duration}ms: ${e.query}`)}),s.$on("error",e=>{console.error("[PRISMA ERROR]:",e)}),process.on("beforeExit",async()=>{await s.$disconnect()}),process.on("SIGINT",async()=>{await s.$disconnect(),process.exit(0)}),process.on("SIGTERM",async()=>{await s.$disconnect(),process.exit(0)})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[8948,5972,1482,1585],()=>r(39719));module.exports=n})();