"use strict";exports.id=5120,exports.ids=[5120],exports.modules={89557:(e,t,s)=>{var i,n;s.d(t,{Ak:()=>l,H4:()=>p,Lu:()=>u,V6:()=>n,k_:()=>h,kx:()=>m,z5:()=>c}),function(e){e.AUTHENTICATION_SUCCESS="authentication_success",e.AUTHENTICATION_FAILED="authentication_failed",e.AUTHORIZATION_DENIED="authorization_denied",e.RATE_LIMIT_EXCEEDED="rate_limit_exceeded",e.SUSPICIOUS_ACTIVITY="suspicious_activity",e.DATA_BREACH_ATTEMPT="data_breach_attempt",e.INJECTION_ATTEMPT="injection_attempt",e.BRUTE_FORCE_ATTEMPT="brute_force_attempt",e.SESSION_HIJACK_ATTEMPT="session_hijack_attempt",e.UNUSUAL_LOGIN_LOCATION="unusual_login_location",e.PAYMENT_FRAUD_ATTEMPT="payment_fraud_attempt",e.ACCOUNT_LOCKOUT="account_lockout",e.PASSWORD_RESET_ABUSE="password_reset_abuse",e.API_ABUSE="api_abuse",e.MALFORMED_REQUEST="malformed_request",e.INVALID_TOKEN="invalid_token",e.EXPIRED_SESSION="expired_session",e.PRIVILEGE_ESCALATION="privilege_escalation",e.DATA_EXPORT_SUSPICIOUS="data_export_suspicious",e.WEBHOOK_MANIPULATION="webhook_manipulation"}(i||(i={})),function(e){e.LOW="low",e.MEDIUM="medium",e.HIGH="high",e.CRITICAL="critical"}(n||(n={}));let r={sqlInjection:[/(\bUNION\b.*\bSELECT\b)/i,/(\bDROP\b.*\bTABLE\b)/i,/(\bINSERT\b.*\bINTO\b)/i,/(\bUPDATE\b.*\bSET\b)/i,/(\bDELETE\b.*\bFROM\b)/i,/('.*OR.*'.*=.*')/i,/(--|\#|\*\/)/,/(\bEXEC\b|\bEXECUTE\b)/i],xss:[/<script[^>]*>.*?<\/script>/gi,/javascript:/i,/on\w+\s*=/i,/<iframe[^>]*>/i,/<embed[^>]*>/i,/<object[^>]*>/i,/eval\s*\(/i,/expression\s*\(/i],pathTraversal:[/\.\.\//,/\.\.\\/,/%2e%2e%2f/i,/%2e%2e%5c/i,/\.\.%2f/i,/\.\.%5c/i],commandInjection:[/;\s*(ls|cat|echo|pwd|whoami|id|uname)/i,/\|\s*(ls|cat|echo|pwd|whoami|id|uname)/i,/`.*`/,/\$\(.*\)/,/&\s*(ls|cat|echo|pwd|whoami|id|uname)/i],nosqlInjection:[/\$where/i,/\$ne/i,/\$in/i,/\$nin/i,/\$regex/i,/\$gt/i,/\$lt/i,/\$or/i,/\$and/i]};class a{constructor(){this.eventBuffer=[],this.bufferSize=100,this.flushInterval=3e4,"undefined"!=typeof setInterval&&setInterval(()=>this.flushBuffer(),this.flushInterval)}static getInstance(){return a.instance||(a.instance=new a),a.instance}async logEvent(e){let t={...e,timestamp:new Date,resolved:!1};this.eventBuffer.push(t);let s=t.severity.toUpperCase();console.warn(`[SECURITY-${s}]`,{type:t.type,path:t.path,ip:t.ipAddress,userId:t.userId,details:t.details,timestamp:t.timestamp.toISOString()}),(this.eventBuffer.length>=this.bufferSize||"critical"===t.severity)&&await this.flushBuffer()}async flushBuffer(){if(0===this.eventBuffer.length)return;let e=[...this.eventBuffer];this.eventBuffer=[];try{console.log(`[Security Logger] Flushing ${e.length} security events`),await this.writeToExternalLog(e)}catch(t){console.error("[Security Logger] Failed to flush events:",t),this.eventBuffer.unshift(...e)}}async writeToExternalLog(e){console.log("[Security Events]",JSON.stringify({timestamp:new Date().toISOString(),service:"facepay-api",events:e.map(e=>({...e,timestamp:e.timestamp.toISOString()}))},null,2))}analyzeRequest(e,t){let s=[],i=0,n=e.nextUrl.toString(),r=e.headers.get("user-agent")||"";if(e.headers.get("referer"),this.analyzeString(n,"url").forEach(e=>{s.push(e),i+=this.getThreatScore(e.severity)}),this.analyzeString(r,"user_agent").forEach(e=>{s.push(e),i+=this.getThreatScore(e.severity)}),t){let e="string"==typeof t?t:JSON.stringify(t);this.analyzeString(e,"request_body").forEach(e=>{s.push(e),i+=this.getThreatScore(e.severity)})}return s.push(...this.detectSuspiciousPatterns(e)),{threats:s,riskScore:i}}analyzeString(e,t){let s=[];return r.sqlInjection.forEach(i=>{let n=e.match(i);n&&s.push({type:"sql_injection",severity:"high",details:{source:t,pattern:i.toString(),match:n[0]}})}),r.xss.forEach(i=>{let n=e.match(i);n&&s.push({type:"xss_attempt",severity:"high",details:{source:t,pattern:i.toString(),match:n[0]}})}),r.pathTraversal.forEach(i=>{let n=e.match(i);n&&s.push({type:"path_traversal",severity:"medium",details:{source:t,pattern:i.toString(),match:n[0]}})}),r.commandInjection.forEach(i=>{let n=e.match(i);n&&s.push({type:"command_injection",severity:"critical",details:{source:t,pattern:i.toString(),match:n[0]}})}),r.nosqlInjection.forEach(i=>{let n=e.match(i);n&&s.push({type:"nosql_injection",severity:"high",details:{source:t,pattern:i.toString(),match:n[0]}})}),s}detectSuspiciousPatterns(e){let t=[],s=e.headers.get("user-agent")||"",i=e.nextUrl.pathname;return[/bot/i,/crawler/i,/spider/i,/scraper/i,/automated/i,/script/i,/python/i,/curl/i,/wget/i,/httpie/i,/postman/i].some(e=>e.test(s))&&t.push({type:"bot_detection",severity:"low",details:{userAgent:s,suspiciousPattern:!0}}),[/nmap/i,/nikto/i,/sqlmap/i,/burp/i,/owasp/i,/zap/i,/nessus/i,/openvas/i,/acunetix/i].some(e=>e.test(s))&&t.push({type:"scanner_detection",severity:"high",details:{userAgent:s,scannerTool:!0}}),[/admin/i,/config/i,/backup/i,/.env/i,/phpinfo/i,/wp-admin/i,/.git/i,/debug/i,/test/i,/tmp/i,/var/i,/etc/i].some(e=>e.test(i))&&t.push({type:"suspicious_path",severity:"medium",details:{path:i,attemptedAccess:!0}}),t}getThreatScore(e){switch(e){case"low":return 1;case"medium":return 3;case"high":return 7;case"critical":return 15;default:return 0}}}let o=a.getInstance();function c(e,t,s){o.logEvent({type:"authentication_success",severity:"low",userId:e,sessionId:s,ipAddress:d(t),userAgent:t.headers.get("user-agent")||"unknown",path:t.nextUrl.pathname,method:t.method,details:{timestamp:new Date().toISOString(),success:!0}})}function l(e,t,s){o.logEvent({type:"authentication_failed",severity:"medium",userId:s,ipAddress:d(e),userAgent:e.headers.get("user-agent")||"unknown",path:e.nextUrl.pathname,method:e.method,details:{reason:t,timestamp:new Date().toISOString()}})}function u(e,t,s,i="medium"){o.logEvent({type:"suspicious_activity",severity:i,userId:s,ipAddress:d(e),userAgent:e.headers.get("user-agent")||"unknown",path:e.nextUrl.pathname,method:e.method,details:{activity:t,timestamp:new Date().toISOString()}})}function p(e,t,s){o.logEvent({type:"payment_fraud_attempt",severity:"critical",userId:s,ipAddress:d(e),userAgent:e.headers.get("user-agent")||"unknown",path:e.nextUrl.pathname,method:e.method,details:{...t,timestamp:new Date().toISOString()}})}function h(e,t){let s=o.analyzeRequest(e,t),i=s.riskScore>=10||s.threats.some(e=>"critical"===e.severity);return i&&u(e,"High-risk request blocked by threat analysis",void 0,"high"),{shouldBlock:i,threats:s.threats,riskScore:s.riskScore}}function d(e){let t=e.headers.get("x-forwarded-for"),s=e.headers.get("x-real-ip"),i=e.headers.get("x-connecting-ip");return t?t.split(",")[0].trim():s||i||"unknown"}class m{static{this.userPatterns=new Map}static analyzeUserBehavior(e,t){let s=d(t),i=t.headers.get("user-agent")||"unknown",n=t.nextUrl.pathname,r=new Date().getHours(),a=this.userPatterns.get(e);a||(a={locations:new Set,devices:new Set,timings:[],paths:new Map},this.userPatterns.set(e,a));let o=[],c=0;a.locations.has(s)||(o.push("new_location"),c+=3,a.locations.add(s));let l=i.substring(0,50);a.devices.has(l)||(o.push("new_device"),c+=2,a.devices.add(l));let u=a.timings.reduce((e,t)=>e+t,0)/a.timings.length;a.timings.length>5&&Math.abs(r-u)>4&&(o.push("unusual_timing"),c+=1),a.timings.push(r),a.timings.length>24&&a.timings.shift();let p=a.paths.get(n)||0;return a.paths.set(n,p+1),0===p&&["/api/users/profile","/api/payments/","/api/transactions/"].some(e=>n.startsWith(e))&&(o.push("first_time_sensitive_access"),c+=2),{anomalies:o,riskScore:c}}}},62065:(e,t,s)=>{s.d(t,{Qx:()=>p,U:()=>u,bY:()=>d,dU:()=>h});var i=s(87070);let n=new Map,r={DEFAULT_WINDOW:9e5,DEFAULT_MAX_REQUESTS:100,STRICT_MAX_REQUESTS:50,AUTH_MAX_REQUESTS:10,PAYMENT_MAX_REQUESTS:20,ALLOWED_ORIGINS:["https://facepay.app","https://www.facepay.app","http://localhost:3000","https://facepay-dabtcavila.vercel.app"].filter(Boolean),CSP:"default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://api.stripe.com wss:; frame-src https://js.stripe.com https://hooks.stripe.com",HSTS:"max-age=31536000; includeSubDomains; preload"};function a(e){let t=e.headers.get("x-forwarded-for"),s=e.headers.get("x-real-ip"),i=e.headers.get("x-connecting-ip");return t?t.split(",")[0].trim():s||i||"unknown"}function o(e,t){let s=e.headers.get("origin");return(!s||r.ALLOWED_ORIGINS.includes("*")||r.ALLOWED_ORIGINS.includes(s))&&t.headers.set("Access-Control-Allow-Origin",s||"*"),t.headers.set("Access-Control-Allow-Methods","GET, POST, PUT, DELETE, OPTIONS"),t.headers.set("Access-Control-Allow-Headers","Content-Type, Authorization, X-Requested-With"),t.headers.set("Access-Control-Allow-Credentials","true"),t.headers.set("Access-Control-Max-Age","86400"),t}function c(e){return e.headers.set("Content-Security-Policy",r.CSP),e.headers.set("Strict-Transport-Security",r.HSTS),e.headers.set("X-Frame-Options","DENY"),e.headers.set("X-Content-Type-Options","nosniff"),e.headers.set("X-XSS-Protection","1; mode=block"),e.headers.set("Referrer-Policy","strict-origin-when-cross-origin"),e.headers.set("Permissions-Policy","camera=(), microphone=(), geolocation=(), payment=()"),e.headers.delete("Server"),e.headers.delete("X-Powered-By"),e}function l(e,t={}){return async s=>{try{if("OPTIONS"===s.method){let e=new i.NextResponse(null,{status:200});return o(s,c(e))}if(!t.skipValidation){let e=function(e){let t=e.headers.get("user-agent"),s=e.headers.get("content-type"),n=e.headers.get("content-length");if(e.headers.get("referer"),!t)return console.warn("[Security] Request blocked - missing user agent:",{ip:a(e),path:e.nextUrl.pathname,timestamp:new Date().toISOString()}),i.NextResponse.json({success:!1,error:"Invalid request"},{status:400});if([/sqlmap/i,/nikto/i,/w3af/i,/nmap/i,/masscan/i,/zmap/i,/nessus/i,/openvas/i,/bot.*crawler/i,/scanner/i].some(e=>e.test(t)))return console.warn("[Security] Suspicious user agent blocked:",{ip:a(e),userAgent:t,path:e.nextUrl.pathname,timestamp:new Date().toISOString()}),i.NextResponse.json({success:!1,error:"Request rejected"},{status:403});if(["POST","PUT","PATCH"].includes(e.method)){if(n&&parseInt(n)>52428800)return console.warn("[Security] Request blocked - payload too large:",{ip:a(e),contentLength:n,path:e.nextUrl.pathname,timestamp:new Date().toISOString()}),i.NextResponse.json({success:!1,error:"Payload too large"},{status:413});!s||s.includes("application/json")||s.includes("multipart/form-data")||s.includes("text/plain")||console.warn("[Security] Invalid content type:",{ip:a(e),contentType:s,path:e.nextUrl.pathname,timestamp:new Date().toISOString()})}return null}(s);if(e)return c(e)}if(!t.skipRateLimit){let e=t.rateLimitOptions||{windowMs:r.DEFAULT_WINDOW,maxRequests:r.DEFAULT_MAX_REQUESTS},o=(function(e){let{windowMs:t,maxRequests:s,skipSuccessfulRequests:r=!1}=e;return e=>{let r=a(e),o=e.headers.get("user-agent")||"unknown",c=`${r}:${e.nextUrl.pathname}:${o.substring(0,50)}`,l=Date.now(),u=n.get(c);return!u||u.resetTime<=l?(n.set(c,{count:1,resetTime:l+t}),null):u.count>=s?(console.warn("[Security] Rate limit exceeded:",{ip:r,path:e.nextUrl.pathname,userAgent:o.substring(0,100),count:u.count,maxRequests:s,timestamp:new Date().toISOString()}),i.NextResponse.json({success:!1,error:"Too many requests. Please try again later.",rateLimitExceeded:!0},{status:429,headers:{"Retry-After":Math.ceil((u.resetTime-l)/1e3).toString(),"X-RateLimit-Limit":s.toString(),"X-RateLimit-Remaining":"0","X-RateLimit-Reset":u.resetTime.toString()}})):(u.count++,n.set(c,u),null)}})(e)(s);if(o)return c(o)}let l=await e(s);return o(s,c(l))}catch(e){return console.error("[Security] Middleware error:",{error:e instanceof Error?e.message:String(e),stack:e instanceof Error?e.stack:void 0,path:s.nextUrl.pathname,method:s.method,ip:a(s),timestamp:new Date().toISOString()}),c(i.NextResponse.json({success:!1,error:"Internal security error"},{status:500}))}}}let u=e=>l(e,{rateLimitOptions:{windowMs:r.DEFAULT_WINDOW,maxRequests:r.AUTH_MAX_REQUESTS}}),p=e=>l(e,{rateLimitOptions:{windowMs:r.DEFAULT_WINDOW,maxRequests:r.PAYMENT_MAX_REQUESTS}}),h=e=>l(e,{rateLimitOptions:{windowMs:r.DEFAULT_WINDOW,maxRequests:r.STRICT_MAX_REQUESTS}}),d=e=>l(e,{skipRateLimit:!0,skipValidation:!0});"undefined"!=typeof setInterval&&setInterval(function(){let e=Date.now(),t=0;for(let[s,i]of n.entries())i.resetTime<=e&&(n.delete(s),t++);t>0&&console.log(`[Security] Cleaned up ${t} expired rate limit entries`)},3e5)}};